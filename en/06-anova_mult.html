<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en-CA" xml:lang="en-CA">

<head>

<meta charset="utf-8" />
<meta name="generator" content="quarto-1.5.37" />

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes" />

<meta name="author" content="Julien Martin" />
<meta name="description" content="Early version needed to be severely updated/modified" />

<title>On the R-way to hell ‚Äì 12¬† Multiway ANOVA: factorial and nested designs</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
/* CSS for syntax highlighting */
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { display: inline-block; text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
  }
pre.numberSource { margin-left: 3em;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
</style>

<!-- htmldependencies:E3FAD763 -->
<script id="quarto-search-options" type="application/json">{
  "location": "navbar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "end",
  "type": "overlay",
  "limit": 50,
  "keyboard-shortcut": [
    "f",
    "/",
    "s"
  ],
  "show-item-context": false,
  "language": {
    "search-no-results-text": "No results",
    "search-matching-documents-text": "matching documents",
    "search-copy-link-title": "Copy link to search",
    "search-hide-matches-text": "Hide additional matches",
    "search-more-match-text": "more match in this document",
    "search-more-matches-text": "more matches in this document",
    "search-clear-button-title": "Clear",
    "search-text-placeholder": "",
    "search-detached-cancel-button-title": "Cancel",
    "search-submit-button-title": "Submit",
    "search-label": "Search"
  }
}</script>
<script async src="https://www.googletagmanager.com/gtag/js?id=G-SLXFYRXJR4"></script>

<script type="text/javascript">

window.dataLayer = window.dataLayer || [];
function gtag(){dataLayer.push(arguments);}
gtag('js', new Date());
gtag('config', 'G-SLXFYRXJR4', { 'anonymize_ip': true});
</script>

  <script src="https://cdnjs.cloudflare.com/polyfill/v3/polyfill.min.js?features=es6"></script>
  <script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-chtml-full.js" type="text/javascript"></script>

<script type="text/javascript">
const typesetMath = (el) => {
  if (window.MathJax) {
    // MathJax Typeset
    window.MathJax.typeset([el]);
  } else if (window.katex) {
    // KaTeX Render
    var mathElements = el.getElementsByClassName("math");
    var macros = [];
    for (var i = 0; i < mathElements.length; i++) {
      var texText = mathElements[i].firstChild;
      if (mathElements[i].tagName == "SPAN") {
        window.katex.render(texText.data, mathElements[i], {
          displayMode: mathElements[i].classList.contains('display'),
          throwOnError: false,
          macros: macros,
          fleqn: false
        });
      }
    }
  }
}
window.Quarto = {
  typesetMath
};
</script>

</head>

<body>

<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top">
    <nav class="navbar navbar-expand-lg " data-bs-theme="dark">
      <div class="navbar-container container-fluid">
      <div class="navbar-brand-container mx-auto">
    <a class="navbar-brand" href="/index.html">
    <span class="navbar-title">![](images/cover/book_hex_en.png){width=&quot;50px&quot;} R Way</span>
    </a>
  </div>
            <div id="quarto-search" class="" title="Search"></div>
          <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarCollapse"
  aria-controls="navbarCollapse" role="menu" aria-expanded="false" aria-label="Toggle navigation"
  onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
  <span class="navbar-toggler-icon"></span>
</button>
          <div class="collapse navbar-collapse" id="navbarCollapse">
            <ul class="navbar-nav navbar-nav-scroll me-auto">
  <li class="nav-item">
    <a class="nav-link" href="/902-data-files.html"> 
<span class="menu-text">Data</span></a>
  </li>  
  <li class="nav-item dropdown ">
    <a class="nav-link dropdown-toggle" href="#" id="nav-menu-other-resources" role="link" data-bs-toggle="dropdown" aria-expanded="false" >
 <span class="menu-text">Other resources</span>
    </a>
    <ul class="dropdown-menu" aria-labelledby="nav-menu-other-resources">    
        <li>
    <a class="dropdown-item" href="https://biostats-uottawa.github.io/">
 <span class="dropdown-text">Biostats uOttawa</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="https://biostats-uottawa.github.io/bio4158_course/">
 <span class="dropdown-text">Biostats with R (Bio4158)</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="https://biostats-uottawa.github.io/bio4558_cours/">
 <span class="dropdown-text">Biostats avec R (Bio4558)</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="https://biostats-uottawa.github.io/bio8940_course/">
 <span class="dropdown-text">Advanced biostats and open science (Bio8940)</span></a>
  </li>  
    </ul>
  </li>
</ul>
            <ul class="navbar-nav navbar-nav-scroll ms-auto">
  <li class="nav-item dropdown ">
    <a class="nav-link dropdown-toggle" href="#" id="nav-menu-bi-flag" role="link" data-bs-toggle="dropdown" aria-expanded="false" >
      <i 
  class="bi bi-flag" 
  role="img" 
>
</i> 
 <span class="menu-text"></span>
    </a>
    <ul class="dropdown-menu dropdown-menu-end" aria-labelledby="nav-menu-bi-flag">    
        <li>
    <a class="dropdown-item" href="/../fr">
 <span class="dropdown-text">Fran√ßais</span></a>
  </li>  
    </ul>
  </li>
</ul>
          </div> <!-- /navcollapse -->
            <div class="quarto-navbar-tools tools-wide">
    <a href="https://github.com/biostats-uottawa/R_way/"  title="Source Code" class="quarto-navigation-tool px-1" aria-label="Source Code"><i class="bi bi-github"></i></a>
    <div class="dropdown">
      <a href="" title="Download" id="quarto-navigation-tool-dropdown-0" class="quarto-navigation-tool dropdown-toggle px-1" data-bs-toggle="dropdown" aria-expanded="false" role="link" aria-label="Download"><i class="bi bi-download"></i></a>
      <ul class="dropdown-menu" aria-labelledby="quarto-navigation-tool-dropdown-0">
          <li>
            <a class="dropdown-item quarto-navbar-tools-item" href="/On-the-R-way-to-hell.pdf">
              <i class="bi bi-file-pdf pe-1"></i>
            Download PDF
            </a>
          </li>
          <li>
            <a class="dropdown-item quarto-navbar-tools-item" href="/On-the-R-way-to-hell.epub">
              <i class="bi bi-journal pe-1"></i>
            Download ePub
            </a>
          </li>
      </ul>
    </div>
  <a href="" class="quarto-color-scheme-toggle quarto-navigation-tool  px-1" onclick="window.quartoToggleColorScheme(); return false;" title="Toggle dark mode"><i class="bi"></i></a>
  <a href="" class="quarto-reader-toggle quarto-navigation-tool px-1" onclick="window.quartoToggleReader(); return false;" title="Toggle reader mode">
  <div class="quarto-reader-toggle-btn">
  <i class="bi"></i>
  </div>
</a>
</div>
      </div> <!-- /container-fluid -->
    </nav>
  <nav class="quarto-secondary-nav">
    <div class="container-fluid d-flex">
      <button type="button" class="quarto-btn-toggle btn"
      data-bs-toggle="collapse" role="button" data-bs-target=".quarto-sidebar-collapse-item" 
      aria-controls="quarto-sidebar" aria-expanded="false" aria-label="Toggle sidebar navigation"
      onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
        <i class="bi bi-layout-text-sidebar-reverse"></i>
      </button>
        <h1 class="quarto-secondary-nav-title no-breadcrumbs"></h1>
        <a class="flex-grow-1" role="navigation" data-bs-toggle="collapse" data-bs-target=".quarto-sidebar-collapse-item" role="link"
        aria-controls="quarto-sidebar" aria-expanded="false" aria-label="Toggle sidebar navigation"
        onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">      
        </a>
    </div>
  </nav>
</header>
<!-- content -->
<div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-article page-navbar">
<!-- sidebar -->
  <nav id="quarto-sidebar" class="sidebar collapse collapse-horizontal quarto-sidebar-collapse-item sidebar-navigation floating overflow-auto">
    <div class="sidebar-menu-container"> 
    <ul class="list-unstyled mt-1">
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="/index.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Preface</span></a>
  </div>
</li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-1"  role="navigation" aria-expanded="true">
 <span class="menu-text">Using R</span></a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-1" role="navigation" aria-expanded="true" aria-label="Toggle section">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-1" class="collapse list-unstyled sidebar-section depth1 show">  
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="/01-start.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class='chapter-number'>1</span>¬† <span class='chapter-title'>Getting started</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="/02-basics.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class='chapter-number'>2</span>¬† <span class='chapter-title'>Some R basics</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="/03-data.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class='chapter-number'>3</span>¬† <span class='chapter-title'>Data</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="/04-graphics_short.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class='chapter-number'>4</span>¬† <span class='chapter-title'>Figures</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="/05-programming.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class='chapter-number'>5</span>¬† <span class='chapter-title'>Programming</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="/06-quarto.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class='chapter-number'>6</span>¬† <span class='chapter-title'>Reproducible reports with Quarto</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="/07-github.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class='chapter-number'>7</span>¬† <span class='chapter-title'>Version control with Git and GitHub</span></span></a>
  </div>
</li>
      </ul>
  </li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-2"  role="navigation" aria-expanded="true">
 <span class="menu-text">Fundamentals of stats</span></a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-2" role="navigation" aria-expanded="true" aria-label="Toggle section">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-2" class="collapse list-unstyled sidebar-section depth1 show">  
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="/25-power.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class='chapter-number'>8</span>¬† <span class='chapter-title'>Power Analysis with R and G\*Power</span></span></a>
  </div>
</li>
      </ul>
  </li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-3"  role="navigation" aria-expanded="true">
 <span class="menu-text">Linear models</span></a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-3" role="navigation" aria-expanded="true" aria-label="Toggle section">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-3" class="collapse list-unstyled sidebar-section depth1 show">  
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="/31-reg_lin.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class='chapter-number'>9</span>¬† <span class='chapter-title'>Correlation and simple linear regression</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="/32-t_test.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class='chapter-number'>10</span>¬† <span class='chapter-title'>Two - sample comparisons</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="/33-anova.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class='chapter-number'>11</span>¬† <span class='chapter-title'>One-way ANOVA</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="/06-anova_mult.html" class="sidebar-item-text sidebar-link active">
 <span class="menu-text"><span class='chapter-number'>12</span>¬† <span class='chapter-title'>Multiway ANOVA: factorial and nested designs</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="/35-reg_mult.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class='chapter-number'>13</span>¬† <span class='chapter-title'>Multiple regression</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="/36-ancova_glm.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class='chapter-number'>14</span>¬† <span class='chapter-title'>ANCOVA and general linear model</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="/37-model_freq.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class='chapter-number'>15</span>¬† <span class='chapter-title'>Analysis of frequency data: Contingency Tables, Log-Linear Models, and Poisson Regression</span></span></a>
  </div>
</li>
      </ul>
  </li>
        <li class="sidebar-item sidebar-item-section">
      <span class="sidebar-item-text sidebar-link text-start">
 <span class="menu-text">Generalized linear models</span></span>
  </li>
        <li class="sidebar-item sidebar-item-section">
      <span class="sidebar-item-text sidebar-link text-start">
 <span class="menu-text">Mixed models</span></span>
  </li>
        <li class="sidebar-item sidebar-item-section">
      <span class="sidebar-item-text sidebar-link text-start">
 <span class="menu-text">Generalized additive models</span></span>
  </li>
        <li class="sidebar-item sidebar-item-section">
      <span class="sidebar-item-text sidebar-link text-start">
 <span class="menu-text">Multivariate analysis</span></span>
  </li>
        <li class="sidebar-item sidebar-item-section">
      <span class="sidebar-item-text sidebar-link text-start">
 <span class="menu-text">Bayesian approach</span></span>
  </li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="/901-references.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">References</span></a>
  </div>
</li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-9"  role="navigation" aria-expanded="true">
 <span class="menu-text">Appendices</span></a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-9" role="navigation" aria-expanded="true" aria-label="Toggle section">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-9" class="collapse list-unstyled sidebar-section depth1 show">  
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="/902-data-files.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class='chapter-number'>A</span>¬† <span class='chapter-title'>Data used in this book</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="/903-latex.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class='chapter-number'>B</span>¬† <span class='chapter-title'>Installing Quarto and LateX</span></span></a>
  </div>
</li>
      </ul>
  </li>
    </ul>
    </div>
</nav>
<div id="quarto-sidebar-glass" class="quarto-sidebar-collapse-item" data-bs-toggle="collapse" data-bs-target=".quarto-sidebar-collapse-item" ></div>
<!-- margin-sidebar -->
    <div id="quarto-margin-sidebar" class="sidebar margin-sidebar">
        <div id="quarto-toc-target"></div>
    </div>
<!-- main -->
<main class="content" id="quarto-document-content">

<header id="title-block-header" class="quarto-title-block default">
<div class="quarto-title">
<h1 class="title"><span class="chapter-number">12</span>¬† <span class="chapter-title">Multiway ANOVA: factorial and nested designs</span></h1>
</div>



<div class="quarto-title-meta">

    
  
    
  </div>
  


</header>

<nav id="TOC" role="doc-toc">
    <h2 id="toc-title">Table of contents</h2>
   
  <ul>
  <li><a href="#set-anomul" id="toc-set-anomul"><span class="header-section-number">12.1</span> R packages and data needed</a></li>
  <li><a href="#two-way-factorial-design-with-replication" id="toc-two-way-factorial-design-with-replication"><span class="header-section-number">12.2</span> Two-way factorial design with replication</a>
  <ul>
  <li><a href="#fixed-effects-anova-model-i" id="toc-fixed-effects-anova-model-i"><span class="header-section-number">12.2.1</span> Fixed effects ANOVA (Model I)</a></li>
  <li><a href="#mixed-effects-anova-model-iii" id="toc-mixed-effects-anova-model-iii"><span class="header-section-number">12.2.2</span> Mixed effects ANOVA (Model III)</a></li>
  </ul></li>
  <li><a href="#way-factorial-anova-without-replication" id="toc-way-factorial-anova-without-replication"><span class="header-section-number">12.3</span> 2-way factorial ANOVA without replication</a></li>
  <li><a href="#nested-designs" id="toc-nested-designs"><span class="header-section-number">12.4</span> Nested designs</a></li>
  <li><a href="#two-way-non-parametric-anova" id="toc-two-way-non-parametric-anova"><span class="header-section-number">12.5</span> Two-way non-parametric ANOVA</a></li>
  <li><a href="#multiple-comparisons" id="toc-multiple-comparisons"><span class="header-section-number">12.6</span> Multiple comparisons</a></li>
  <li><a href="#test-de-permutation-pour-lanova-√†-deux-facteurs-de-classification" id="toc-test-de-permutation-pour-lanova-√†-deux-facteurs-de-classification"><span class="header-section-number">12.7</span> Test de permutation pour l‚ÄôANOVA √† deux facteurs de classification</a></li>
  <li><a href="#bootstrap-for-two-way-anova" id="toc-bootstrap-for-two-way-anova"><span class="header-section-number">12.8</span> Bootstrap for two-way ANOVA</a></li>
  </ul>
</nav>
<p>After completing this laboratory exercise, you should be able to:</p>
<ul>
<li>Use R to do parametric ANOVAs for 2-way factorial designs with replication.</li>
<li>Use R to do 2-way factorial design ANOVA without replication</li>
<li>Use R to do parametric ANOVAs for nested designs with replication.</li>
<li>Use R to do non-parametric 2-way ANOVAs</li>
<li>Use R to do multiway pairwise comparisons</li>
</ul>
<p>Be aware that there are a large number of possible ANOVA designs, many of which can be handled by R: this laboratory is</p>
<section id="set-anomul" class="level2" data-number="12.1">
<h2 data-number="12.1"><span class="header-section-number">12.1</span> R packages and data needed</h2>
<p>For this lab you need:</p>
<ul>
<li>R packages:
<ul>
<li>tidyverse</li>
<li>multicomp</li>
<li>car</li>
<li>effects</li>
</ul></li>
<li>data files:
<ul>
<li>Stu2wdat.csv</li>
<li>Stu2mdat.csv</li>
<li>nr2wdat.csv</li>
<li>nestdat.csv</li>
<li>wmcdat2.csv</li>
<li>wmc2dat2.csv</li>
</ul></li>
</ul>
<div class="cell">
<div class="sourceCode" id="cb1"><pre class="sourceCode r cell-code"><code class="sourceCode r"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(multcomp)</span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(car)</span>
<span id="cb1-3"><a href="#cb1-3" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(tidyverse)</span>
<span id="cb1-4"><a href="#cb1-4" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(effects)</span></code></pre></div>
</div>
</section>
<section id="two-way-factorial-design-with-replication" class="level2" data-number="12.2">
<h2 data-number="12.2"><span class="header-section-number">12.2</span> Two-way factorial design with replication</h2>
<p>Many experiments are designed to investigate the joint effects of several different factors: in a two-way ANOVA, we examine the effect of two factors, but in principle the analysis can be extended to three, four or even five factors, although interpreting the results from 4- and 5-way ANOVAs can be very difficult.</p>
<p>Suppose that we are interested in the effects of two factors: <code>location</code> (Cumberland House and The Pas) and <code>sex</code> (male or female) on sturgeon size (data can be found in <code>Stu2wdat.csv</code>). Note that because the sample sizes are not the same for each group, this is an unbalanced design. Note also that there are missing data for some of the variables, meaning that not every measurement was made on every fish.</p>
<section id="fixed-effects-anova-model-i" class="level3" data-number="12.2.1">
<h3 data-number="12.2.1"><span class="header-section-number">12.2.1</span> Fixed effects ANOVA (Model I)</h3>
<ul>
<li>Begin by having a look at the data by generating box plots of <code>rdwght</code> for <code>sex</code> and <code>location</code> from the file <code>Stu2wdat.csv</code> .</li>
</ul>
<div class="callout callout-style-default callout-tip callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class='callout-icon'></i>
</div>
<div class="callout-title-container flex-fill">
Solution
</div>
</div>
<div class="callout-body-container callout-body">
<div class="cell">
<div class="sourceCode" id="cb2"><pre class="sourceCode r cell-code"><code class="sourceCode r"><span id="cb2-1"><a href="#cb2-1" aria-hidden="true" tabindex="-1"></a>Stu2wdat <span class="ot">&lt;-</span> <span class="fu">read.csv</span>(<span class="st">&quot;data/Stu2wdat.csv&quot;</span>)</span>
<span id="cb2-2"><a href="#cb2-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-3"><a href="#cb2-3" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(Stu2wdat, <span class="fu">aes</span>(<span class="at">x =</span> sex, <span class="at">y =</span> rdwght)) <span class="sc">+</span></span>
<span id="cb2-4"><a href="#cb2-4" aria-hidden="true" tabindex="-1"></a><span class="fu">geom_boxplot</span>(<span class="at">notch =</span> <span class="cn">TRUE</span>) <span class="sc">+</span></span>
<span id="cb2-5"><a href="#cb2-5" aria-hidden="true" tabindex="-1"></a><span class="fu">facet_grid</span>(<span class="sc">~</span>location)</span></code></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>Warning: Removed 4 rows containing non-finite outside the scale range
(`stat_boxplot()`).</code></pre>
</div>
<div class="cell-output-display">
<div>
<figure>
<p><img src="06-anova_mult_files/figure-html/unnamed-chunk-3-1.png" class="img-fluid" width="672" /></p>
</figure>
</div>
</div>
</div>
</div>
</div>
<p>From this, it appears as though females might be larger at both locations. It‚Äôs difficult to get an idea of whether fish differ in size between the two locations. The presence of outliers on these plots suggests there might be problems meeting normality assumptions for the residuals.</p>
<ul>
<li>Generate summary statistics for rdwght by sex and location .</li>
</ul>
<div class="cell">
<div class="sourceCode" id="cb4"><pre class="sourceCode r cell-code"><code class="sourceCode r"><span id="cb4-1"><a href="#cb4-1" aria-hidden="true" tabindex="-1"></a>Stu2wdat <span class="ot">&lt;-</span> <span class="fu">read.csv</span>(<span class="st">&quot;data/Stu2wdat.csv&quot;</span>)</span>
<span id="cb4-2"><a href="#cb4-2" aria-hidden="true" tabindex="-1"></a><span class="fu">aggregate</span>(rdwght <span class="sc">~</span> sex <span class="sc">+</span> location, <span class="at">data =</span> Stu2wdat, <span class="at">FUN =</span> <span class="st">&quot;summary&quot;</span>)</span></code></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>           sex     location rdwght.Min. rdwght.1st Qu. rdwght.Median
1 FEMALE       CUMBERLAND      15.10000       20.40000      26.80000
2 MALE         CUMBERLAND      14.00000       19.22500      20.85000
3 FEMALE       THE_PAS         12.54000       19.14000      27.39000
4 MALE         THE_PAS          4.73000       14.63000      20.79000
  rdwght.Mean rdwght.3rd Qu. rdwght.Max.
1    27.37347       31.40000    55.60000
2    22.14118       23.90000    35.60000
3    27.97717       33.88000    93.72000
4    20.64652       24.94250    49.94000</code></pre>
</div>
</div>
<p>The summary statistics confirm our interpretation of the box plots: females appear to be larger than males, and differences in fish size between locations are small.</p>
<ul>
<li>Using the file <code>Stu2wdat.csv</code> , do a two-way factorial ANOVA:</li>
</ul>
<div class="cell">
<div class="sourceCode" id="cb6"><pre class="sourceCode r cell-code"><code class="sourceCode r"><span id="cb6-1"><a href="#cb6-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Fit anova model and plot residual diagnostics</span></span>
<span id="cb6-2"><a href="#cb6-2" aria-hidden="true" tabindex="-1"></a><span class="co"># but first, save current par and set graphic page to hold 4 graphs</span></span>
<span id="cb6-3"><a href="#cb6-3" aria-hidden="true" tabindex="-1"></a>opar <span class="ot">&lt;-</span> <span class="fu">par</span>(<span class="at">mfrow =</span> <span class="fu">c</span>(<span class="dv">2</span>, <span class="dv">2</span>))</span>
<span id="cb6-4"><a href="#cb6-4" aria-hidden="true" tabindex="-1"></a>anova.model1 <span class="ot">&lt;-</span> <span class="fu">lm</span>(rdwght <span class="sc">~</span> sex <span class="sc">+</span> location <span class="sc">+</span> sex<span class="sc">:</span>location,</span>
<span id="cb6-5"><a href="#cb6-5" aria-hidden="true" tabindex="-1"></a>  <span class="at">contrasts =</span> <span class="fu">list</span>(<span class="at">sex =</span> contr.sum, <span class="at">location =</span> contr.sum),</span>
<span id="cb6-6"><a href="#cb6-6" aria-hidden="true" tabindex="-1"></a>  <span class="at">data =</span> Stu2wdat</span>
<span id="cb6-7"><a href="#cb6-7" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb6-8"><a href="#cb6-8" aria-hidden="true" tabindex="-1"></a><span class="fu">anova</span>(anova.model1)</span></code></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Analysis of Variance Table

Response: rdwght
              Df  Sum Sq Mean Sq F value    Pr(&gt;F)    
sex            1  1839.6 1839.55 18.6785 2.569e-05 ***
location       1     4.3    4.26  0.0433    0.8355    
sex:location   1    48.7   48.69  0.4944    0.4829    
Residuals    178 17530.4   98.49                      
---
Signif. codes:  0 &#39;***&#39; 0.001 &#39;**&#39; 0.01 &#39;*&#39; 0.05 &#39;.&#39; 0.1 &#39; &#39; 1</code></pre>
</div>
</div>
<div class="callout callout-style-default callout-warning callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class='callout-icon'></i>
</div>
<div class="callout-title-container flex-fill">
Warning
</div>
</div>
<div class="callout-body-container callout-body">
<p>Be careful here. R gives you the sequential sums of squares (Type I) and associated Mean squares and probabilities. These are not to be trusted unless the design is perfectly balanced. In this case, there are varying numbers of observations across sex and location combinations and therefore the design is not balanced.</p>
</div>
</div>
<p>What you want are the partial sums of squares (type III). The easiest way to get them is to use the Anova() function in the <code>car</code> üì¶ package (note the subtle difference, <code>Anova()</code> is not the same as <code>anova()</code>, remember case matters in R.). However, this is not enough by itself. To get the proper values for the type III sums of square, one also needs to specify contrasts, hence the cryptic <code>contrasts = list(sex = contr.sum,location = contr.sum)</code>.</p>
<div class="cell">
<div class="sourceCode" id="cb8"><pre class="sourceCode r cell-code"><code class="sourceCode r"><span id="cb8-1"><a href="#cb8-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(car)</span>
<span id="cb8-2"><a href="#cb8-2" aria-hidden="true" tabindex="-1"></a><span class="fu">Anova</span>(anova.model1, <span class="at">type =</span> <span class="dv">3</span>)</span></code></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Anova Table (Type III tests)

Response: rdwght
             Sum Sq  Df   F value    Pr(&gt;F)    
(Intercept)  106507   1 1081.4552 &lt; 2.2e-16 ***
sex            1745   1   17.7220 4.051e-05 ***
location          9   1    0.0891    0.7656    
sex:location     49   1    0.4944    0.4829    
Residuals     17530 178                        
---
Signif. codes:  0 &#39;***&#39; 0.001 &#39;**&#39; 0.01 &#39;*&#39; 0.05 &#39;.&#39; 0.1 &#39; &#39; 1</code></pre>
</div>
</div>
<p>On the basis of the ANOVA, there is no reason to reject two null hypotheses: (1) that the effect of sex (if any) does not depend on location (no interaction), and (2) that there is no difference in the size of sturgeon (pooled over sex ) between the two locations . On the other hand, we reject the null hypothesis that there is no difference in size between male and female sturgeon (pooled over location ), precisely as expected from the graphs.</p>
<div class="cell">
<div class="sourceCode" id="cb10"><pre class="sourceCode r cell-code"><code class="sourceCode r"><span id="cb10-1"><a href="#cb10-1" aria-hidden="true" tabindex="-1"></a><span class="fu">par</span>(<span class="at">mfrow =</span> <span class="fu">c</span>(<span class="dv">2</span>, <span class="dv">2</span>))</span>
<span id="cb10-2"><a href="#cb10-2" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(anova.model1)</span></code></pre></div>
<div class="cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure>
<p><img src="06-anova_mult_files/figure-html/unnamed-chunk-7-1.png" class="img-fluid" width="672" /></p>
<figcaption>Checking model assumptions for ANOVA model1</figcaption>
</figure>
</div>
</div>
</div>
<p>As usual, we cannot accept the above results without first ensuring that the assumptions of ANOVA are met. Examination of the residuals plots above shows that the residuals are reasonably normally distributed, with the exception of three potential outliers flagged on the QQ plot (cases 101, 24, &amp; 71; the latter two are on top of one another). However, Cook‚Äôs distances are not large for these (the 0.5 contour is not even visible on the plot), so there is little indication that these are a concern.The residuals vs fit plot shows that the spread of residuals is about equal over the range of the fitted values, again with the exception of a few cases. When we test for normality of residuals we get:</p>
<div class="cell">
<div class="sourceCode" id="cb11"><pre class="sourceCode r cell-code"><code class="sourceCode r"><span id="cb11-1"><a href="#cb11-1" aria-hidden="true" tabindex="-1"></a><span class="fu">shapiro.test</span>(<span class="fu">residuals</span>(anova.model1))</span></code></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>
    Shapiro-Wilk normality test

data:  residuals(anova.model1)
W = 0.87213, p-value = 2.619e-11</code></pre>
</div>
</div>
<p>So, there is evidence of non-normality in the residuals.</p>
<p>We will use the Levene‚Äôs test to examine the assumption of homogeneity of variances, just as we did with the 1-way anova.</p>
<div class="cell">
<div class="sourceCode" id="cb13"><pre class="sourceCode r cell-code"><code class="sourceCode r"><span id="cb13-1"><a href="#cb13-1" aria-hidden="true" tabindex="-1"></a><span class="fu">leveneTest</span>(rdwght <span class="sc">~</span> sex <span class="sc">*</span> location, <span class="at">data =</span> Stu2wdat)</span></code></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Levene&#39;s Test for Homogeneity of Variance (center = median)
       Df F value  Pr(&gt;F)  
group   3  3.8526 0.01055 *
      178                  
---
Signif. codes:  0 &#39;***&#39; 0.001 &#39;**&#39; 0.01 &#39;*&#39; 0.05 &#39;.&#39; 0.1 &#39; &#39; 1</code></pre>
</div>
</div>
<p>If the assumption of homogeneity of variances was valid, we would be accepting the null that the mean of the absolute values of residuals does not vary among levels of sex and location (i.e., group ). The above table shows that the hypothesis is rejected and we conclude there is evidence of heteroscedascticity. All in all, there is some evidence that several important assumptions have been violated. However, whether these violations are sufficiently large to invalidate our conclusions remains to be seen.</p>
<div class="callout callout-style-default callout-caution callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class='callout-icon'></i>
</div>
<div class="callout-title-container flex-fill">
Exercise
</div>
</div>
<div class="callout-body-container callout-body">
<p>Repeat this procedure using the data file Stu2mdat.Rdata . Now what do you conclude? Suppose you wanted to compare the sizes of males and females: in what way would these comparisons differ between Stu2wdat.Rdata and Stu2mdat.Rdata ?</p>
</div>
</div>
<div class="callout callout-style-default callout-tip callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class='callout-icon'></i>
</div>
<div class="callout-title-container flex-fill">
Solution
</div>
</div>
<div class="callout-body-container callout-body">
<div class="cell">
<div class="sourceCode" id="cb15"><pre class="sourceCode r cell-code"><code class="sourceCode r"><span id="cb15-1"><a href="#cb15-1" aria-hidden="true" tabindex="-1"></a>Stu2mdat <span class="ot">&lt;-</span> <span class="fu">read.csv</span>(<span class="st">&quot;data/Stu2mdat.csv&quot;</span>)</span>
<span id="cb15-2"><a href="#cb15-2" aria-hidden="true" tabindex="-1"></a>anova.model2 <span class="ot">&lt;-</span> <span class="fu">lm</span>(</span>
<span id="cb15-3"><a href="#cb15-3" aria-hidden="true" tabindex="-1"></a>  <span class="at">formula =</span> rdwght <span class="sc">~</span> sex <span class="sc">+</span> location <span class="sc">+</span> sex<span class="sc">:</span>location,</span>
<span id="cb15-4"><a href="#cb15-4" aria-hidden="true" tabindex="-1"></a>  <span class="at">contrasts =</span> <span class="fu">list</span>(<span class="at">sex =</span> contr.sum, <span class="at">location =</span> contr.sum),</span>
<span id="cb15-5"><a href="#cb15-5" aria-hidden="true" tabindex="-1"></a>  <span class="at">data =</span> Stu2mdat</span>
<span id="cb15-6"><a href="#cb15-6" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb15-7"><a href="#cb15-7" aria-hidden="true" tabindex="-1"></a><span class="fu">summary</span>(anova.model2)</span>
<span id="cb15-8"><a href="#cb15-8" aria-hidden="true" tabindex="-1"></a><span class="fu">Anova</span>(anova.model2, <span class="at">type =</span> <span class="dv">3</span>)</span></code></pre></div>
</div>
</div>
</div>
<div class="cell">
<div class="cell-output cell-output-stdout">
<pre><code>
Call:
lm(formula = rdwght ~ sex + location + sex:location, data = Stu2mdat, 
    contrasts = list(sex = contr.sum, location = contr.sum))

Residuals:
    Min      1Q  Median      3Q     Max 
-15.917  -6.017  -0.580   4.445  65.743 

Coefficients:
               Estimate Std. Error t value Pr(&gt;|t|)    
(Intercept)     24.5346     0.7461  32.885  &lt; 2e-16 ***
sex1            -0.5246     0.7461  -0.703    0.483    
location1        0.2227     0.7461   0.299    0.766    
sex1:location1   3.1407     0.7461   4.210 4.05e-05 ***
---
Signif. codes:  0 &#39;***&#39; 0.001 &#39;**&#39; 0.01 &#39;*&#39; 0.05 &#39;.&#39; 0.1 &#39; &#39; 1

Residual standard error: 9.924 on 178 degrees of freedom
  (4 observations deleted due to missingness)
Multiple R-squared:  0.09744,   Adjusted R-squared:  0.08223 
F-statistic: 6.405 on 3 and 178 DF,  p-value: 0.0003817</code></pre>
</div>
</div>
<p>Note that in this case, we see that at Cumberland House, females are larger than males, whereas the opposite is true in The Pas (you can confirm this observation by generating summary statistics). What happens with the ANOVA (remember, you want Type III sum of squares)?</p>
<div class="cell">
<div class="cell-output cell-output-stdout">
<pre><code>Anova Table (Type III tests)

Response: rdwght
             Sum Sq  Df   F value    Pr(&gt;F)    
(Intercept)  106507   1 1081.4552 &lt; 2.2e-16 ***
sex              49   1    0.4944    0.4829    
location          9   1    0.0891    0.7656    
sex:location   1745   1   17.7220 4.051e-05 ***
Residuals     17530 178                        
---
Signif. codes:  0 &#39;***&#39; 0.001 &#39;**&#39; 0.01 &#39;*&#39; 0.05 &#39;.&#39; 0.1 &#39; &#39; 1</code></pre>
</div>
</div>
<p>In this case, the interaction term <code>sex:location</code> is significant but the main effects are not significant.</p>
<ul>
<li>You might find it useful here to generate plots for the two data files to compare the interactions between <code>sex</code> and <code>location</code>. The effect plot shows the relationship between means for each combination of factors (also called cell means). Generate an effect plot for the two models using the <code>allEffects()</code> command from the <code>effects</code> üì¶ package:</li>
</ul>
<div class="cell">
<div class="sourceCode" id="cb18"><pre class="sourceCode r cell-code"><code class="sourceCode r"><span id="cb18-1"><a href="#cb18-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(effects)</span>
<span id="cb18-2"><a href="#cb18-2" aria-hidden="true" tabindex="-1"></a><span class="fu">allEffects</span>(anova.model1)</span></code></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code> model: rdwght ~ sex + location + sex:location

 sex*location effect
              location
sex            CUMBERLAND   THE_PAS     
  FEMALE           27.37347     27.97717
  MALE             22.14118     20.64652</code></pre>
</div>
<div class="sourceCode" id="cb20"><pre class="sourceCode r cell-code"><code class="sourceCode r"><span id="cb20-1"><a href="#cb20-1" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(<span class="fu">allEffects</span>(anova.model1), <span class="st">&quot;sex:location&quot;</span>)</span></code></pre></div>
<div class="cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure>
<p><img src="06-anova_mult_files/figure-html/unnamed-chunk-13-1.png" class="img-fluid" width="672" /></p>
<figcaption>Effet du sexe et du lieu sur le poids des esturgeons</figcaption>
</figure>
</div>
</div>
</div>
<div class="cell">
<div class="sourceCode" id="cb21"><pre class="sourceCode r cell-code"><code class="sourceCode r"><span id="cb21-1"><a href="#cb21-1" aria-hidden="true" tabindex="-1"></a><span class="fu">allEffects</span>(anova.model2)</span></code></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code> model: rdwght ~ sex + location + sex:location

 sex*location effect
              location
sex            CUMBERLAND   THE_PAS     
  FEMALE           27.37347     20.64652
  MALE             22.14118     27.97717</code></pre>
</div>
<div class="sourceCode" id="cb23"><pre class="sourceCode r cell-code"><code class="sourceCode r"><span id="cb23-1"><a href="#cb23-1" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(<span class="fu">allEffects</span>(anova.model2), <span class="st">&quot;sex:location&quot;</span>)</span></code></pre></div>
<div class="cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure>
<p><img src="06-anova_mult_files/figure-html/unnamed-chunk-14-1.png" class="img-fluid" width="672" /></p>
<figcaption>Effet du sexe et du lieu sur le poids des esturgeons</figcaption>
</figure>
</div>
</div>
</div>
<p>There is a very large difference between the results from <code>Stu2wdat</code> and <code>Stu2mdat</code>. In the former case, because there is no significant interaction, we can essentially pool over the levels of factor 1 (<code>sex</code>, say) to test for the effects of location , or over the levels of factor 2 (<code>location</code>) to test for the effects of sex . In fact, if we do so and simply run a one-way ANOVA on the <code>Stu2wdat</code> data with sex as the grouping variable, we get:</p>
<div class="cell">
<div class="sourceCode" id="cb24"><pre class="sourceCode r cell-code"><code class="sourceCode r"><span id="cb24-1"><a href="#cb24-1" aria-hidden="true" tabindex="-1"></a><span class="fu">Anova</span>(<span class="fu">aov</span>(rdwght <span class="sc">~</span> sex, <span class="at">data =</span> Stu2wdat), <span class="at">type =</span> <span class="dv">3</span>)</span></code></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Anova Table (Type III tests)

Response: rdwght
            Sum Sq  Df F value    Pr(&gt;F)    
(Intercept)  78191   1 800.440 &lt; 2.2e-16 ***
sex           1840   1  18.831 2.377e-05 ***
Residuals    17583 180                      
---
Signif. codes:  0 &#39;***&#39; 0.001 &#39;**&#39; 0.01 &#39;*&#39; 0.05 &#39;.&#39; 0.1 &#39; &#39; 1</code></pre>
</div>
</div>
<p>Note that here the residual sum of squares (17583) is only slightly higher than for the 2-way model (17530), simply because, in the 2-way model, only a small fraction of the explained sums of squares is due to the location main effect or the sex:LOCATION interaction. On the other hand, if you try the same trick with <code>stu2mdat</code>, you get:</p>
<!-- need to add r code to grad the value of SS in text -->
<div class="cell">
<div class="sourceCode" id="cb26"><pre class="sourceCode r cell-code"><code class="sourceCode r"><span id="cb26-1"><a href="#cb26-1" aria-hidden="true" tabindex="-1"></a><span class="fu">Anova</span>(<span class="fu">aov</span>(rdwght <span class="sc">~</span> sex, <span class="at">data =</span> Stu2mdat), <span class="at">type =</span> <span class="dv">3</span>)</span></code></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Anova Table (Type III tests)

Response: rdwght
            Sum Sq  Df  F value Pr(&gt;F)    
(Intercept)  55251   1 515.0435 &lt;2e-16 ***
sex            113   1   1.0571 0.3053    
Residuals    19309 180                    
---
Signif. codes:  0 &#39;***&#39; 0.001 &#39;**&#39; 0.01 &#39;*&#39; 0.05 &#39;.&#39; 0.1 &#39; &#39; 1</code></pre>
</div>
</div>
<p>Here, the residuals sum of squares (19309) is much larger than in the 2-way model (17530), because most of the explained sums of squares is due to the interaction. Note that if we did this, we would conclude that male and female sturgeons don‚Äôt differ in size. But in fact they do: it‚Äôs just that the difference is in different directions, depending on location. This is why it is always dangerous to try and make too much of main effects in the presence of interactions!</p>
</section>
<section id="mixed-effects-anova-model-iii" class="level3" data-number="12.2.2">
<h3 data-number="12.2.2"><span class="header-section-number">12.2.2</span> Mixed effects ANOVA (Model III)</h3>
<p>We have neglected an important component in the above analyses, and that is related to the type of ANOVA model we wish to run. In this example, Location could be considered a random effect, whereas sex is a fixed effect (because it is ‚Äúfixed‚Äù biologically), and so this model could be treated as a mixed model (Model III) ANOVA. Note that in these analyses, R treats analyses by default as Model I ANOVA, so that the main effects and the interaction are tested over the residuals mean square. Recall, however, that in a Model III ANOVA, main effects are tested over the interaction mean square or the pooled interaction mean square and residual mean square (depending on which statistician you consult!)</p>
<ul>
<li>Working with the <code>Stu2wdat</code> data, rebuild the ANOVA table for <code>rdwght</code> for the situation in which <code>location</code> is a random factor and <code>sex</code> is a fixed factor. To do this, you need to recalculate the F-ratio for sex using the <code>sex:location</code> interaction mean square instead of the residual mean square. This is most easily accomplished by hand, making sure you are working with the Type III Sums of squares ANOVA table.</li>
</ul>
<div class="callout callout-style-default callout-tip callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class='callout-icon'></i>
</div>
<div class="callout-title-container flex-fill">
Solution
</div>
</div>
<div class="callout-body-container callout-body">
<div class="cell">
<div class="sourceCode" id="cb28"><pre class="sourceCode r cell-code"><code class="sourceCode r"><span id="cb28-1"><a href="#cb28-1" aria-hidden="true" tabindex="-1"></a><span class="fu">Anova</span>(anova.model1, <span class="at">type =</span> <span class="dv">3</span>)</span></code></pre></div>
</div>
</div>
</div>
<div class="cell">
<div class="cell-output cell-output-stdout">
<pre><code>Anova Table (Type III tests)

Response: rdwght
             Sum Sq  Df   F value    Pr(&gt;F)    
(Intercept)  106507   1 1081.4552 &lt; 2.2e-16 ***
sex            1745   1   17.7220 4.051e-05 ***
location          9   1    0.0891    0.7656    
sex:location     49   1    0.4944    0.4829    
Residuals     17530 178                        
---
Signif. codes:  0 &#39;***&#39; 0.001 &#39;**&#39; 0.01 &#39;*&#39; 0.05 &#39;.&#39; 0.1 &#39; &#39; 1</code></pre>
</div>
</div>
<p>For <code>sex</code>, the new ratio of mean squares is</p>
<p><span class="math display">\[F = \frac{(1745/1)}{(49/1)} = 35.6\]</span></p>
<p>To assign a probability to the new <code>F-value</code>, enter the following in the commands window: <code>pf(F, df1, df2, lower.tail = FALSE)</code> , where <code>F</code> is the newly calculated <code>F-value</code>, and <code>df1</code> and <code>df2</code> are the degrees of freedom of the numerator (<code>sex</code>) and denominator (<code>SEX:location</code>), respectively.</p>
<div class="cell">
<div class="sourceCode" id="cb30"><pre class="sourceCode r cell-code"><code class="sourceCode r"><span id="cb30-1"><a href="#cb30-1" aria-hidden="true" tabindex="-1"></a><span class="fu">pf</span>(<span class="fl">35.6</span>, <span class="dv">1</span>, <span class="dv">1</span>, <span class="at">lower.tail =</span> <span class="cn">FALSE</span>)</span></code></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 0.1057152</code></pre>
</div>
</div>
<p>Note that the <em>p value</em> for <code>sex</code> is now non-significant. This is because the error MS of the initial ANOVA is smaller than the interaction MS, but mostly because the number of degrees of freedom of the denominator of the F test has dropped from 178 to 1. In general, a drop in the denominator degrees of freedom makes it much more difficult to reach significance.</p>
<div class="callout callout-style-default callout-note callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class='callout-icon'></i>
</div>
<div class="callout-title-container flex-fill">
Note
</div>
</div>
<div class="callout-body-container callout-body">
<p>Mixed model which are a generalisation of mixed-effect ANOVA are now really developped and are to be favoured intead of doing it by hand.</p>
</div>
</div>
</section>
</section>
<section id="way-factorial-anova-without-replication" class="level2" data-number="12.3">
<h2 data-number="12.3"><span class="header-section-number">12.3</span> 2-way factorial ANOVA without replication</h2>
<p>In some experimental designs, there are no replicates within data cells: perhaps it is simply too expensive to obtain more than one datum per cell. A 2-way ANOVA is still possible under these circumstances, but there is an important limitation.</p>
<div class="callout callout-style-default callout-warning callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class='callout-icon'></i>
</div>
<div class="callout-title-container flex-fill">
Warning
</div>
</div>
<div class="callout-body-container callout-body">
<p>Because there is no replication within cells, there is no error variance: we have simply a row sum of squares, a column sum of squares, and a remainder sum of squares. This has important implications: if there is an interaction in a Model III ANOVA, only the fixed effect can be tested (over the remainder MS); for Model I ANOVAs, or for random effects in Model III ANOVAs, it is not appropriate to test main effects over the remainder unless we are sure there is no interaction.</p>
</div>
</div>
<p>A limnologist studying Round Lake in Algonquin Park takes a single temperature ( <code>temp</code> ) reading at 10 different depths ( <code>depth</code> , in m) at four times ( date) over the course of the summer. Her data are shown in <code>Nr2wdat.csv</code>.</p>
<ul>
<li>Do a two-way unreplicated ANOVA using temp as the dependent vari able, date and depth as the factor variables (you will need to recode depth to tell R to treat this variable as a factor). Note that there is no interaction term included in this model.</li>
</ul>
<div class="cell">
<div class="sourceCode" id="cb32"><pre class="sourceCode r cell-code"><code class="sourceCode r"><span id="cb32-1"><a href="#cb32-1" aria-hidden="true" tabindex="-1"></a>nr2wdat <span class="ot">&lt;-</span> <span class="fu">read.csv</span>(<span class="st">&quot;data/nr2wdat.csv&quot;</span>)</span>
<span id="cb32-2"><a href="#cb32-2" aria-hidden="true" tabindex="-1"></a>nr2wdat<span class="sc">$</span>depth <span class="ot">&lt;-</span> <span class="fu">as.factor</span>(nr2wdat<span class="sc">$</span>depth)</span>
<span id="cb32-3"><a href="#cb32-3" aria-hidden="true" tabindex="-1"></a>anova.model4 <span class="ot">&lt;-</span> <span class="fu">lm</span>(temp <span class="sc">~</span> date <span class="sc">+</span> depth, <span class="at">data =</span> nr2wdat)</span>
<span id="cb32-4"><a href="#cb32-4" aria-hidden="true" tabindex="-1"></a><span class="fu">Anova</span>(anova.model4, <span class="at">type =</span> <span class="dv">3</span>)</span></code></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Anova Table (Type III tests)

Response: temp
             Sum Sq Df  F value    Pr(&gt;F)    
(Intercept) 1511.99  1 125.5652 1.170e-11 ***
date         591.15  3  16.3641 2.935e-06 ***
depth       1082.82  9   9.9916 1.450e-06 ***
Residuals    325.12 27                       
---
Signif. codes:  0 &#39;***&#39; 0.001 &#39;**&#39; 0.01 &#39;*&#39; 0.05 &#39;.&#39; 0.1 &#39; &#39; 1</code></pre>
</div>
</div>
<p>Assuming that this is a Model III ANOVA ( <code>date</code> random, <code>depth</code> fixed), what do you conclude? (Hint: you may want to generate an interaction plot of temp versus depth and month, just to see what‚Äôs going on.)</p>
<div class="cell">
<div class="sourceCode" id="cb34"><pre class="sourceCode r cell-code"><code class="sourceCode r"><span id="cb34-1"><a href="#cb34-1" aria-hidden="true" tabindex="-1"></a><span class="fu">interaction.plot</span>(nr2wdat<span class="sc">$</span>depth, nr2wdat<span class="sc">$</span>date, nr2wdat<span class="sc">$</span>temp)</span></code></pre></div>
<div class="cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure>
<p><img src="06-anova_mult_files/figure-html/unnamed-chunk-21-1.png" class="img-fluid" width="672" /></p>
<figcaption>Effet du mois et de la profondeur sur la temp√©rature</figcaption>
</figure>
</div>
</div>
</div>
<p>There is a highly significant decrease in temperature as depth increases. To test the effect of month (the (assumed) random factor), we must assume that there is no interaction between depth and month, i.e.¬†that the change in temperature with depth is the same for each month. This is a dubious assumption: if you plot temperature against depth for each month, you should see that the temperature profile becomes increasingly non-linear as the summer progresses (i.e.¬†the thermocline develops), from almost a linear decline in early spring to what amounts to a step decline in August. In other words, the relationship between temperature and depth does change with month, so that if you were to use the above fitted model to estimate, say, the temperature at a depth of 5 m in July, you would not get a particularly good estimate.</p>
<p>In terms of residual diagnostics, have a look at the residuals probability plot and residuals vs fitted values plot.</p>
<div class="cell">
<div class="sourceCode" id="cb35"><pre class="sourceCode r cell-code"><code class="sourceCode r"><span id="cb35-1"><a href="#cb35-1" aria-hidden="true" tabindex="-1"></a><span class="fu">par</span>(<span class="at">mfrow =</span> <span class="fu">c</span>(<span class="dv">2</span>, <span class="dv">2</span>))</span>
<span id="cb35-2"><a href="#cb35-2" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(anova.model4)</span></code></pre></div>
<div class="cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure>
<p><img src="06-anova_mult_files/figure-html/unnamed-chunk-22-1.png" class="img-fluid" width="672" /></p>
<figcaption>Conditions d‚Äôapplications du mod√®le anova.model4</figcaption>
</figure>
</div>
</div>
</div>
<div class="cell">
<div class="sourceCode" id="cb36"><pre class="sourceCode r cell-code"><code class="sourceCode r"><span id="cb36-1"><a href="#cb36-1" aria-hidden="true" tabindex="-1"></a><span class="fu">shapiro.test</span>(<span class="fu">residuals</span>(anova.model4))</span></code></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>
    Shapiro-Wilk normality test

data:  residuals(anova.model4)
W = 0.95968, p-value = 0.1634</code></pre>
</div>
</div>
<p>Testing the residuals for normality, we get <code>p = 0.16</code>, so that the normality assumption seems to be O.K. In terms of heteroscedasticity, we can only test among months, using depths as replicates (or among depths using months as replicates). Using depths as replicates within months, we find</p>
<div class="cell">
<div class="sourceCode" id="cb38"><pre class="sourceCode r cell-code"><code class="sourceCode r"><span id="cb38-1"><a href="#cb38-1" aria-hidden="true" tabindex="-1"></a><span class="fu">leveneTest</span>(temp <span class="sc">~</span> date, <span class="at">data =</span> nr2wdat)</span></code></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>Warning in leveneTest.default(y = y, group = group, ...): group coerced to
factor.</code></pre>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>Levene&#39;s Test for Homogeneity of Variance (center = median)
      Df F value    Pr(&gt;F)    
group  3  17.979 2.679e-07 ***
      36                      
---
Signif. codes:  0 &#39;***&#39; 0.001 &#39;**&#39; 0.01 &#39;*&#39; 0.05 &#39;.&#39; 0.1 &#39; &#39; 1</code></pre>
</div>
</div>
<p>So there seems to be some problem here, as can be plainly seen in the above plot of residuals vs fit. All in all, this analysis is not very satisfactory: there appears to be some problems with the assumptions, and the assumption of no interaction between depth and date would appear to be invalid.</p>
</section>
<section id="nested-designs" class="level2" data-number="12.4">
<h2 data-number="12.4"><span class="header-section-number">12.4</span> Nested designs</h2>
<p>A common experimental design occurs when each major group (or treatment) is divided into randomly chosen subgroups. For example, a geneticist interested in the effects of genotype on desiccation resistance in fruit flies might conduct an experiment with larvae of three different genotypes. For each genotype (major group), she sets up three environmental chambers (sub-groups, replicates within groups) with a fixed temperature humidity regime, and in each chamber, she has five larvae for which she records the number of hours each larvae survived.</p>
<ul>
<li>The file <code>Nestdat.csv</code> contains the results of just such an experi ment. The file lists three variables: genotype , chamber and survival . Run a nested ANOVA with survival as the dependent variable, genotype/chamber as the independent variables (this is the shorthand notation for a chamber effect nested under genotype).</li>
</ul>
<div class="cell">
<div class="sourceCode" id="cb41"><pre class="sourceCode r cell-code"><code class="sourceCode r"><span id="cb41-1"><a href="#cb41-1" aria-hidden="true" tabindex="-1"></a>nestdat <span class="ot">&lt;-</span> <span class="fu">read.csv</span>(<span class="st">&quot;data/nestdat.csv&quot;</span>)</span>
<span id="cb41-2"><a href="#cb41-2" aria-hidden="true" tabindex="-1"></a>nestdat<span class="sc">$</span>chamber <span class="ot">&lt;-</span> <span class="fu">as.factor</span>(nestdat<span class="sc">$</span>chamber)</span>
<span id="cb41-3"><a href="#cb41-3" aria-hidden="true" tabindex="-1"></a>nestdat<span class="sc">$</span>genotype <span class="ot">&lt;-</span> <span class="fu">as.factor</span>(nestdat<span class="sc">$</span>genotype)</span>
<span id="cb41-4"><a href="#cb41-4" aria-hidden="true" tabindex="-1"></a>anova.nested <span class="ot">&lt;-</span> <span class="fu">lm</span>(survival <span class="sc">~</span> genotype <span class="sc">/</span> chamber, <span class="at">data =</span> nestdat)</span></code></pre></div>
</div>
<p>What do you conclude from this analysis? What analysis would (should) you do next? (Hint: if there is a non-significant effect of chambers within genotypes, then you can increase the power of between-genotype comparisons by pooling over chambers within genotypes, although not everyone (Dr.¬†Rundle included) agrees with such pooling.) Do it! Make sure you check your assumptions!</p>
<div class="callout callout-style-default callout-tip callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class='callout-icon'></i>
</div>
<div class="callout-title-container flex-fill">
Solution
</div>
</div>
<div class="callout-body-container callout-body">
<div class="cell">
<div class="sourceCode" id="cb42"><pre class="sourceCode r cell-code"><code class="sourceCode r"><span id="cb42-1"><a href="#cb42-1" aria-hidden="true" tabindex="-1"></a><span class="fu">anova</span>(anova.nested)</span></code></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Analysis of Variance Table

Response: survival
                 Df  Sum Sq Mean Sq  F value Pr(&gt;F)    
genotype          2 2952.22 1476.11 292.6081 &lt;2e-16 ***
genotype:chamber  6   40.65    6.78   1.3432 0.2639    
Residuals        36  181.61    5.04                    
---
Signif. codes:  0 &#39;***&#39; 0.001 &#39;**&#39; 0.01 &#39;*&#39; 0.05 &#39;.&#39; 0.1 &#39; &#39; 1</code></pre>
</div>
<div class="sourceCode" id="cb44"><pre class="sourceCode r cell-code"><code class="sourceCode r"><span id="cb44-1"><a href="#cb44-1" aria-hidden="true" tabindex="-1"></a><span class="fu">par</span>(<span class="at">mfrow =</span> <span class="fu">c</span>(<span class="dv">2</span>, <span class="dv">2</span>))</span>
<span id="cb44-2"><a href="#cb44-2" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(anova.nested)</span></code></pre></div>
<div class="cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure>
<p><img src="06-anova_mult_files/figure-html/unnamed-chunk-26-1.png" class="img-fluid" width="672" /></p>
<figcaption>Conditions d‚Äôapplications du mod√®le anova.nested</figcaption>
</figure>
</div>
</div>
</div>
</div>
</div>
<p>We conclude from this analysis that there is no (significant) variation among chambers within genotypes, but that the null hypothesis that all genotypes have the same dessiccation resistance (as measured by survival) is rejected (Test of genotype using MS genotype:chamber as denominator: F = 1476.11/6.78 = 217.7153, P&lt;0.0001). In other words, genotypes differ in their survival.</p>
<p>Since the chambers within genotypes effect is non-significant, we may want to pool over chambers to increase our degrees of freedom:</p>
<div class="cell">
<div class="sourceCode" id="cb45"><pre class="sourceCode r cell-code"><code class="sourceCode r"><span id="cb45-1"><a href="#cb45-1" aria-hidden="true" tabindex="-1"></a>anova.simple <span class="ot">&lt;-</span> <span class="fu">lm</span>(survival <span class="sc">~</span> genotype, <span class="at">data =</span> nestdat)</span>
<span id="cb45-2"><a href="#cb45-2" aria-hidden="true" tabindex="-1"></a><span class="fu">anova</span>(anova.simple)</span></code></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Analysis of Variance Table

Response: survival
          Df  Sum Sq Mean Sq F value    Pr(&gt;F)    
genotype   2 2952.22 1476.11  278.93 &lt; 2.2e-16 ***
Residuals 42  222.26    5.29                      
---
Signif. codes:  0 &#39;***&#39; 0.001 &#39;**&#39; 0.01 &#39;*&#39; 0.05 &#39;.&#39; 0.1 &#39; &#39; 1</code></pre>
</div>
</div>
<p>Thus, we conclude that there is significant variation among the three genotypes in dessiccation resistance.</p>
<p>A box plot of survival across genotypes shows clearly that there is significant variation among the three genotypes in dessiccation resistance. This can be combined with a formal Tukey multiple comparison test:</p>
<div class="cell">
<div class="sourceCode" id="cb47"><pre class="sourceCode r cell-code"><code class="sourceCode r"><span id="cb47-1"><a href="#cb47-1" aria-hidden="true" tabindex="-1"></a><span class="fu">par</span>(<span class="at">mfrow =</span> <span class="fu">c</span>(<span class="dv">1</span>, <span class="dv">1</span>))</span>
<span id="cb47-2"><a href="#cb47-2" aria-hidden="true" tabindex="-1"></a><span class="co"># Compute and plot means and Tukey CI</span></span>
<span id="cb47-3"><a href="#cb47-3" aria-hidden="true" tabindex="-1"></a>means <span class="ot">&lt;-</span> <span class="fu">glht</span>(anova.simple, <span class="at">linfct =</span> <span class="fu">mcp</span>(</span>
<span id="cb47-4"><a href="#cb47-4" aria-hidden="true" tabindex="-1"></a>  <span class="at">genotype =</span></span>
<span id="cb47-5"><a href="#cb47-5" aria-hidden="true" tabindex="-1"></a>    <span class="st">&quot;Tukey&quot;</span></span>
<span id="cb47-6"><a href="#cb47-6" aria-hidden="true" tabindex="-1"></a>))</span>
<span id="cb47-7"><a href="#cb47-7" aria-hidden="true" tabindex="-1"></a>cimeans <span class="ot">&lt;-</span> <span class="fu">cld</span>(means)</span>
<span id="cb47-8"><a href="#cb47-8" aria-hidden="true" tabindex="-1"></a><span class="co"># use sufficiently large upper margin</span></span>
<span id="cb47-9"><a href="#cb47-9" aria-hidden="true" tabindex="-1"></a>old.par <span class="ot">&lt;-</span> <span class="fu">par</span>(<span class="at">mai =</span> <span class="fu">c</span>(<span class="dv">1</span>, <span class="dv">1</span>, <span class="fl">1.25</span>, <span class="dv">1</span>))</span>
<span id="cb47-10"><a href="#cb47-10" aria-hidden="true" tabindex="-1"></a><span class="co"># plot</span></span>
<span id="cb47-11"><a href="#cb47-11" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(cimeans, <span class="at">las =</span> <span class="dv">1</span>) <span class="co"># las option to put y-axis labels as God intended them</span></span></code></pre></div>
<div class="cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure>
<p><img src="06-anova_mult_files/figure-html/unnamed-chunk-28-1.png" class="img-fluid" width="672" /></p>
<figcaption>Effet du genotype sur la r√©sistance √† la dessication avec un test de Tukey</figcaption>
</figure>
</div>
</div>
</div>
<p>So, we conclude from the Tukey analysis and plot that dessiccation resistance (R) , as measured by larval survival under hot, dry conditions, varies significantly among all three genotypes with R(AA) &gt; R(Aa) &gt; R(aa).</p>
<p>Before concluding this, however, we must test the assumptions. Here are the residual plots and diagnostics for the one-way (unnested) design:</p>
<div class="callout callout-style-default callout-tip callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class='callout-icon'></i>
</div>
<div class="callout-title-container flex-fill">
Solution
</div>
</div>
<div class="callout-body-container callout-body">
<div class="cell">
<div class="sourceCode" id="cb48"><pre class="sourceCode r cell-code"><code class="sourceCode r"><span id="cb48-1"><a href="#cb48-1" aria-hidden="true" tabindex="-1"></a><span class="fu">par</span>(<span class="at">mfrow =</span> <span class="fu">c</span>(<span class="dv">2</span>, <span class="dv">2</span>))</span>
<span id="cb48-2"><a href="#cb48-2" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(anova.simple)</span></code></pre></div>
<div class="cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure>
<p><img src="06-anova_mult_files/figure-html/unnamed-chunk-29-1.png" class="img-fluid" width="672" /></p>
<figcaption>Conditions d‚Äôapplications du mod√®le anova.simple</figcaption>
</figure>
</div>
</div>
</div>
</div>
</div>
<p>So, all the assumptions appear to be valid, and the conclusion reached above still holds. Note that if you compare the residual mean squares of the nested and one-way ANOVAs (5.04 vs 5.29), they are almost identical. This is not surprising, given the small contribution of the chamber %in% genotype effect to the explained sum of squares.</p>
</section>
<section id="two-way-non-parametric-anova" class="level2" data-number="12.5">
<h2 data-number="12.5"><span class="header-section-number">12.5</span> Two-way non-parametric ANOVA</h2>
<p>Two-way non-parametric ANOVA is an extension of the non-parametric one-way methods discussed previously. The basic procedure is to rank all the data in the sample from smallest to largest, then carry out a 2-way ANOVA on the ranks. This can be done either for replicated or unreplicated data.</p>
<p>Using the data file <code>Stu2wdat.csv</code> , do a two-factor ANOVA to examine the effects of <code>sex</code> and <code>location</code> on <code>rank(rdwght)</code>.</p>
<div class="cell">
<div class="sourceCode" id="cb49"><pre class="sourceCode r cell-code"><code class="sourceCode r"><span id="cb49-1"><a href="#cb49-1" aria-hidden="true" tabindex="-1"></a>aov.rank <span class="ot">&lt;-</span> <span class="fu">aov</span>(</span>
<span id="cb49-2"><a href="#cb49-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">rank</span>(rdwght) <span class="sc">~</span> sex <span class="sc">*</span> location,</span>
<span id="cb49-3"><a href="#cb49-3" aria-hidden="true" tabindex="-1"></a>  <span class="at">contrasts =</span> <span class="fu">list</span>(</span>
<span id="cb49-4"><a href="#cb49-4" aria-hidden="true" tabindex="-1"></a>    <span class="at">sex =</span> contr.sum, <span class="at">location =</span> contr.sum</span>
<span id="cb49-5"><a href="#cb49-5" aria-hidden="true" tabindex="-1"></a>  ),</span>
<span id="cb49-6"><a href="#cb49-6" aria-hidden="true" tabindex="-1"></a>  <span class="at">data =</span> Stu2wdat</span>
<span id="cb49-7"><a href="#cb49-7" aria-hidden="true" tabindex="-1"></a>)</span></code></pre></div>
</div>
<p>The Scheirer-Ray-Hare extension of the Kruskall-Wallis test is done by computing a statistic H given by the effect sums of squares (SS) divided by the total MS. The latter can be calculated as the variance of the ranks. We compute an H statistic for each term. The H-statistics are then compared to a theoretical <span class="math inline">\(\chi^2\)</span> (chi-square) distribution using the command line: <code>pchisq(H, df, lower.tail = FALSE)</code> , where <code>H</code> and <code>df</code> are the calculated H-statistics and associated degrees of freedom, respectively.</p>
<ul>
<li>Use the ANOVA table based on ranks to test the effects of <code>sex</code> and on <code>rdwght</code>. What do you conclude? How does this result compare with the result obtained with the parametric 2-way ANOVA done before?</li>
</ul>
<div class="cell">
<div class="sourceCode" id="cb50"><pre class="sourceCode r cell-code"><code class="sourceCode r"><span id="cb50-1"><a href="#cb50-1" aria-hidden="true" tabindex="-1"></a><span class="fu">Anova</span>(aov.rank, <span class="at">type =</span> <span class="dv">3</span>)</span></code></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Anova Table (Type III tests)

Response: rank(rdwght)
              Sum Sq  Df  F value    Pr(&gt;F)    
(Intercept)  1499862   1 577.8673 &lt; 2.2e-16 ***
sex            58394   1  22.4979 4.237e-06 ***
location        1128   1   0.4347    0.5105    
sex:location    1230   1   0.4738    0.4921    
Residuals     472383 182                       
---
Signif. codes:  0 &#39;***&#39; 0.001 &#39;**&#39; 0.01 &#39;*&#39; 0.05 &#39;.&#39; 0.1 &#39; &#39; 1</code></pre>
</div>
</div>
<p>To calculate the Scheirer-Ray-Hare extension to the Kruskall-Wallis test, you must first calculate the total mean square (MS), i.e.¬†the variance of the ranked data. In this case, there are 186 observations, their ranks are therefore the series 1, 2, 3, ‚Ä¶, 186. The variance can be calculated simply as var(1:186) (Isn‚Äôt R neat? Cryptic maybe, but neat). So we can compute the <code>H</code> statistic for each term:</p>
<div class="cell">
<div class="sourceCode" id="cb52"><pre class="sourceCode r cell-code"><code class="sourceCode r"><span id="cb52-1"><a href="#cb52-1" aria-hidden="true" tabindex="-1"></a>Hsex <span class="ot">&lt;-</span> <span class="dv">58394</span> <span class="sc">/</span> <span class="fu">var</span>(<span class="dv">1</span><span class="sc">:</span><span class="dv">186</span>)</span>
<span id="cb52-2"><a href="#cb52-2" aria-hidden="true" tabindex="-1"></a>Hlocation <span class="ot">&lt;-</span> <span class="dv">1128</span> <span class="sc">/</span> <span class="fu">var</span>(<span class="dv">1</span><span class="sc">:</span><span class="dv">186</span>)</span>
<span id="cb52-3"><a href="#cb52-3" aria-hidden="true" tabindex="-1"></a>Hsexloc <span class="ot">&lt;-</span> <span class="dv">1230</span> <span class="sc">/</span> <span class="fu">var</span>(<span class="dv">1</span><span class="sc">:</span><span class="dv">186</span>)</span></code></pre></div>
</div>
<p>And convert these statistics into p-values:</p>
<div class="cell">
<div class="sourceCode" id="cb53"><pre class="sourceCode r cell-code"><code class="sourceCode r"><span id="cb53-1"><a href="#cb53-1" aria-hidden="true" tabindex="-1"></a><span class="co"># sex</span></span>
<span id="cb53-2"><a href="#cb53-2" aria-hidden="true" tabindex="-1"></a>Hsex</span></code></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 20.14628</code></pre>
</div>
<div class="sourceCode" id="cb55"><pre class="sourceCode r cell-code"><code class="sourceCode r"><span id="cb55-1"><a href="#cb55-1" aria-hidden="true" tabindex="-1"></a><span class="fu">pchisq</span>(Hsex, <span class="dv">1</span>, <span class="at">lower.tail =</span> <span class="cn">FALSE</span>)</span></code></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 7.173954e-06</code></pre>
</div>
<div class="sourceCode" id="cb57"><pre class="sourceCode r cell-code"><code class="sourceCode r"><span id="cb57-1"><a href="#cb57-1" aria-hidden="true" tabindex="-1"></a><span class="co"># location</span></span>
<span id="cb57-2"><a href="#cb57-2" aria-hidden="true" tabindex="-1"></a>Hlocation</span></code></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 0.3891668</code></pre>
</div>
<div class="sourceCode" id="cb59"><pre class="sourceCode r cell-code"><code class="sourceCode r"><span id="cb59-1"><a href="#cb59-1" aria-hidden="true" tabindex="-1"></a><span class="fu">pchisq</span>(Hlocation, <span class="dv">1</span>, <span class="at">lower.tail =</span> <span class="cn">FALSE</span>)</span></code></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 0.5327377</code></pre>
</div>
<div class="sourceCode" id="cb61"><pre class="sourceCode r cell-code"><code class="sourceCode r"><span id="cb61-1"><a href="#cb61-1" aria-hidden="true" tabindex="-1"></a><span class="co"># sex:location</span></span>
<span id="cb61-2"><a href="#cb61-2" aria-hidden="true" tabindex="-1"></a>Hsexloc</span></code></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 0.4243574</code></pre>
</div>
<div class="sourceCode" id="cb63"><pre class="sourceCode r cell-code"><code class="sourceCode r"><span id="cb63-1"><a href="#cb63-1" aria-hidden="true" tabindex="-1"></a><span class="fu">pchisq</span>(Hsexloc, <span class="dv">1</span>, <span class="at">lower.tail =</span> <span class="cn">FALSE</span>)</span></code></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 0.5147707</code></pre>
</div>
</div>
<p>Note that these results are the same as those obtained in our original two-way parametric ANOVA. Despite the reduced power, we still find significant differences between the sexes, but still no interaction and no effect due to location.</p>
<p>There is, however, an important difference. Recall that in the original parametric ANOVA, there was a significant effect of sex when we considered the problem as a Model I ANOVA. However, if we consider it as Model III, the significant sex effect could in principle disappear, because the df associated with the interaction MS are much smaller than the df associated with the Model I error MS. In this case, however, the interaction MS is about half that of the error MS. So, the significant sex effect becomes even more significant if we analyze the problem as a Model III ANOVA. Once again, we see the importance of specifying the appropriate ANOVA design.</p>
</section>
<section id="multiple-comparisons" class="level2" data-number="12.6">
<h2 data-number="12.6"><span class="header-section-number">12.6</span> Multiple comparisons</h2>
<p>Further hypothesis testing in multiway ANOVAs depends critically on the outcome of the initial ANOVA. If you are interested in comparing groups of marginal means (that is, means of treatments for one factor pooled over levels of the other factor, e.g., between male and female sturgeon pooled over location), this can be done exactly as outlined for multiple comparisons for one-way ANOVAs. For comparison of individual cell means, you must specify the interaction as the group variable.</p>
<p>The file <code>wmcdat2.csv</code> shows measured oxygen consumption ( <code>o2cons</code> ) of two species ( <code>species</code> = A, B)) of limpets at three different concentrations of seawater ( <code>conc</code> = 100, 75, 50%) taken from Sokal and Rohlf, 1995, p.¬†332.</p>
<ul>
<li>Run a 2-way factorial ANOVA on <code>wmcdat2</code> data, using <code>o2cons</code> as the dependent variable and species and conc as the factors. What do you conclude?</li>
</ul>
<div class="callout callout-style-default callout-tip callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class='callout-icon'></i>
</div>
<div class="callout-title-container flex-fill">
Solution
</div>
</div>
<div class="callout-body-container callout-body">
<div class="cell">
<div class="sourceCode" id="cb65"><pre class="sourceCode r cell-code"><code class="sourceCode r"><span id="cb65-1"><a href="#cb65-1" aria-hidden="true" tabindex="-1"></a>wmcdat2 <span class="ot">&lt;-</span> <span class="fu">read.csv</span>(<span class="st">&quot;data/wmcdat2.csv&quot;</span>)</span>
<span id="cb65-2"><a href="#cb65-2" aria-hidden="true" tabindex="-1"></a>wmcdat2<span class="sc">$</span>species <span class="ot">&lt;-</span> <span class="fu">as.factor</span>(wmcdat2<span class="sc">$</span>species)</span>
<span id="cb65-3"><a href="#cb65-3" aria-hidden="true" tabindex="-1"></a>wmcdat2<span class="sc">$</span>conc <span class="ot">&lt;-</span> <span class="fu">as.factor</span>(wmcdat2<span class="sc">$</span>conc)</span>
<span id="cb65-4"><a href="#cb65-4" aria-hidden="true" tabindex="-1"></a>anova.model5 <span class="ot">&lt;-</span> <span class="fu">lm</span>(o2cons <span class="sc">~</span> species <span class="sc">*</span> conc, <span class="at">data =</span> wmcdat2)</span>
<span id="cb65-5"><a href="#cb65-5" aria-hidden="true" tabindex="-1"></a><span class="fu">Anova</span>(anova.model5, <span class="at">type =</span> <span class="dv">3</span>)</span></code></pre></div>
</div>
</div>
</div>
<p>The ANOVA table is shown below. Technically, because the sample sizes in individual cells are rather small, this analysis should be repeated using a non-parametric ANOVA. For the moment, let‚Äôs stick with the parametric analysis.</p>
<div class="cell">
<div class="cell-output cell-output-stdout">
<pre><code>Anova Table (Type III tests)

Response: o2cons
              Sum Sq Df  F value    Pr(&gt;F)    
(Intercept)  1185.60  1 124.0165 4.101e-14 ***
species         0.09  1   0.0097   0.92189    
conc           74.90  2   3.9172   0.02755 *  
species:conc   23.93  2   1.2514   0.29656    
Residuals     401.52 42                       
---
Signif. codes:  0 &#39;***&#39; 0.001 &#39;**&#39; 0.01 &#39;*&#39; 0.05 &#39;.&#39; 0.1 &#39; &#39; 1</code></pre>
</div>
</div>
<p>Look at the diagnostic plots:</p>
<div class="callout callout-style-default callout-tip callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class='callout-icon'></i>
</div>
<div class="callout-title-container flex-fill">
Solution
</div>
</div>
<div class="callout-body-container callout-body">
<div class="cell">
<div class="sourceCode" id="cb67"><pre class="sourceCode r cell-code"><code class="sourceCode r"><span id="cb67-1"><a href="#cb67-1" aria-hidden="true" tabindex="-1"></a><span class="fu">par</span>(<span class="at">mfrow =</span> <span class="fu">c</span>(<span class="dv">2</span>, <span class="dv">2</span>))</span>
<span id="cb67-2"><a href="#cb67-2" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(anova.model5)</span></code></pre></div>
<div class="cell-output-display">
<div>
<figure>
<p><img src="06-anova_mult_files/figure-html/unnamed-chunk-36-1.png" class="img-fluid" width="672" /></p>
</figure>
</div>
</div>
</div>
</div>
</div>
<p>Homoscedasticity looks ok, but normality less so.. Testing for normality, we get:</p>
<div class="callout callout-style-default callout-tip callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class='callout-icon'></i>
</div>
<div class="callout-title-container flex-fill">
Solution
</div>
</div>
<div class="callout-body-container callout-body">
<div class="cell">
<div class="sourceCode" id="cb68"><pre class="sourceCode r cell-code"><code class="sourceCode r"><span id="cb68-1"><a href="#cb68-1" aria-hidden="true" tabindex="-1"></a><span class="fu">shapiro.test</span>(<span class="fu">residuals</span>(anova.model5))</span></code></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>
    Shapiro-Wilk normality test

data:  residuals(anova.model5)
W = 0.93692, p-value = 0.01238</code></pre>
</div>
</div>
</div>
</div>
<p>So there is evidence of non-normality, but otherwise everything looks O.K. Since the ANOVA is relatively robust with respect to non-normality, we proceed, but if we wanted to reassure ourselves, we could run a non-parametric ANOVA, and get the same answer.</p>
<ul>
<li>On the basis of the ANOVA results obtained above, which means would you proceed to compare? Why?</li>
</ul>
<div class="callout callout-style-default callout-tip callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class='callout-icon'></i>
</div>
<div class="callout-title-container flex-fill">
Solution
</div>
</div>
<div class="callout-body-container callout-body">
<p>Need to add an explnation here</p>
</div>
</div>
<p>Overall, we conclude that there are no differences among species, and that the effect of concentration does not depend on species (no interaction). Since there is no interaction and no main effect due to species, the only comparison of interest is among salinity concentrations:</p>
<div class="cell">
<div class="sourceCode" id="cb70"><pre class="sourceCode r cell-code"><code class="sourceCode r"><span id="cb70-1"><a href="#cb70-1" aria-hidden="true" tabindex="-1"></a><span class="co"># fit simplified model</span></span>
<span id="cb70-2"><a href="#cb70-2" aria-hidden="true" tabindex="-1"></a>anova.model6 <span class="ot">&lt;-</span> <span class="fu">aov</span>(o2cons <span class="sc">~</span> conc, <span class="at">data =</span> wmcdat2)</span>
<span id="cb70-3"><a href="#cb70-3" aria-hidden="true" tabindex="-1"></a><span class="co"># Make Tukey multiple comparisons</span></span>
<span id="cb70-4"><a href="#cb70-4" aria-hidden="true" tabindex="-1"></a><span class="fu">TukeyHSD</span>(anova.model6)</span></code></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>  Tukey multiple comparisons of means
    95% family-wise confidence level

Fit: aov(formula = o2cons ~ conc, data = wmcdat2)

$conc
           diff       lwr        upr     p adj
75-50  -4.63625 -7.321998 -1.9505018 0.0003793
100-50 -3.25500 -5.940748 -0.5692518 0.0141313
100-75  1.38125 -1.304498  4.0669982 0.4325855</code></pre>
</div>
<div class="sourceCode" id="cb72"><pre class="sourceCode r cell-code"><code class="sourceCode r"><span id="cb72-1"><a href="#cb72-1" aria-hidden="true" tabindex="-1"></a><span class="fu">par</span>(<span class="at">mfrow =</span> <span class="fu">c</span>(<span class="dv">1</span>, <span class="dv">1</span>))</span>
<span id="cb72-2"><a href="#cb72-2" aria-hidden="true" tabindex="-1"></a><span class="co"># Graph of all comparisons for conc</span></span>
<span id="cb72-3"><a href="#cb72-3" aria-hidden="true" tabindex="-1"></a>tuk <span class="ot">&lt;-</span> <span class="fu">glht</span>(anova.model6, <span class="at">linfct =</span> <span class="fu">mcp</span>(<span class="at">conc =</span> <span class="st">&quot;Tukey&quot;</span>))</span>
<span id="cb72-4"><a href="#cb72-4" aria-hidden="true" tabindex="-1"></a><span class="co"># extract information</span></span>
<span id="cb72-5"><a href="#cb72-5" aria-hidden="true" tabindex="-1"></a>tuk.cld <span class="ot">&lt;-</span> <span class="fu">cld</span>(tuk)</span>
<span id="cb72-6"><a href="#cb72-6" aria-hidden="true" tabindex="-1"></a><span class="co"># use sufficiently large upper margin</span></span>
<span id="cb72-7"><a href="#cb72-7" aria-hidden="true" tabindex="-1"></a>old.par <span class="ot">&lt;-</span> <span class="fu">par</span>(<span class="at">mai =</span> <span class="fu">c</span>(<span class="dv">1</span>, <span class="dv">1</span>, <span class="fl">1.25</span>, <span class="dv">1</span>))</span>
<span id="cb72-8"><a href="#cb72-8" aria-hidden="true" tabindex="-1"></a><span class="co"># plot</span></span>
<span id="cb72-9"><a href="#cb72-9" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(tuk.cld)</span></code></pre></div>
<div class="cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure>
<p><img src="06-anova_mult_files/figure-html/unnamed-chunk-38-1.png" class="img-fluid" width="672" /></p>
<figcaption>Comparaison de Tukey des moyennes de consommation d‚Äôoxyg√®n en fonction del la concentration</figcaption>
</figure>
</div>
</div>
<div class="sourceCode" id="cb73"><pre class="sourceCode r cell-code"><code class="sourceCode r"><span id="cb73-1"><a href="#cb73-1" aria-hidden="true" tabindex="-1"></a><span class="fu">par</span>(old.par)</span></code></pre></div>
</div>
<p>So there is evidence of a significant difference in oxygen consumption at a reduction in salinity to 50% of regular seawater, but not at a reduction of only 25%.</p>
<ul>
<li>Repeat the analysis described above using <code>wmc2dat2.csv</code> . How do your results compare with those obtained for <code>wmcdat2.csv</code> ?</li>
</ul>
<div class="callout callout-style-default callout-tip callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class='callout-icon'></i>
</div>
<div class="callout-title-container flex-fill">
Solution
</div>
</div>
<div class="callout-body-container callout-body">
<div class="cell">
<div class="sourceCode" id="cb74"><pre class="sourceCode r cell-code"><code class="sourceCode r"><span id="cb74-1"><a href="#cb74-1" aria-hidden="true" tabindex="-1"></a>wmc2dat2 <span class="ot">&lt;-</span> <span class="fu">read.csv</span>(<span class="st">&quot;data/wmc2dat2.csv&quot;</span>)</span>
<span id="cb74-2"><a href="#cb74-2" aria-hidden="true" tabindex="-1"></a>wmc2dat2<span class="sc">$</span>species <span class="ot">&lt;-</span> <span class="fu">as.factor</span>(wmc2dat2<span class="sc">$</span>species)</span>
<span id="cb74-3"><a href="#cb74-3" aria-hidden="true" tabindex="-1"></a>wmc2dat2<span class="sc">$</span>conc <span class="ot">&lt;-</span> <span class="fu">as.factor</span>(wmc2dat2<span class="sc">$</span>conc)</span>
<span id="cb74-4"><a href="#cb74-4" aria-hidden="true" tabindex="-1"></a>anova.model7 <span class="ot">&lt;-</span> <span class="fu">lm</span>(o2cons <span class="sc">~</span> species <span class="sc">*</span> conc, <span class="at">data =</span> wmc2dat2)</span></code></pre></div>
</div>
</div>
</div>
<p>Using <code>wmc2dat2.csv</code>,we get:</p>
<div class="cell">
<div class="cell-output cell-output-stdout">
<pre><code>Anova Table (Type III tests)

Response: o2cons
             Sum Sq Df F value    Pr(&gt;F)    
(Intercept)  343.09  1 36.2132 3.745e-07 ***
species      133.52  1 14.0929 0.0005286 ***
conc          66.76  2  3.5232 0.0385011 *  
species:conc 168.15  2  8.8742 0.0006101 ***
Residuals    397.91 42                      
---
Signif. codes:  0 &#39;***&#39; 0.001 &#39;**&#39; 0.01 &#39;*&#39; 0.05 &#39;.&#39; 0.1 &#39; &#39; 1</code></pre>
</div>
</div>
<p>Here there is a large interaction effect, and consequently, there is no point in comparing marginal means. This is made clear by examining an interaction plot:</p>
<div class="cell">
<div class="sourceCode" id="cb76"><pre class="sourceCode r cell-code"><code class="sourceCode r"><span id="cb76-1"><a href="#cb76-1" aria-hidden="true" tabindex="-1"></a><span class="fu">with</span>(wmc2dat2, <span class="fu">interaction.plot</span>(conc, species, o2cons))</span></code></pre></div>
<div class="cell-output-display">
<div>
<figure>
<p><img src="06-anova_mult_files/figure-html/unnamed-chunk-41-1.png" class="img-fluid" width="672" /></p>
</figure>
</div>
</div>
</div>
<ul>
<li>Working still with the <code>wmc2dat2</code> data set, compare individual cell means (6 in all), with the Bonferonni adjustment. To do this, it is helpful to create a new variable to indicate all the combinations of <code>species</code> and <code>conc</code>:</li>
</ul>
<div class="cell">
<div class="sourceCode" id="cb77"><pre class="sourceCode r cell-code"><code class="sourceCode r"><span id="cb77-1"><a href="#cb77-1" aria-hidden="true" tabindex="-1"></a>wmc2dat2<span class="sc">$</span>species.conc <span class="ot">&lt;-</span> <span class="fu">as.factor</span>(<span class="fu">paste0</span>(wmc2dat2<span class="sc">$</span>species, wmc2dat2<span class="sc">$</span>conc))</span></code></pre></div>
</div>
<p>Then we can conduct pairwise bonferroni comparisons:</p>
<div class="cell">
<div class="sourceCode" id="cb78"><pre class="sourceCode r cell-code"><code class="sourceCode r"><span id="cb78-1"><a href="#cb78-1" aria-hidden="true" tabindex="-1"></a><span class="fu">with</span>(wmc2dat2, <span class="fu">pairwise.t.test</span>(o2cons, species.conc, <span class="at">p.adj =</span> <span class="st">&quot;bonf&quot;</span>))</span></code></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>
    Pairwise comparisons using t tests with pooled SD 

data:  o2cons and species.conc 

     A100   A50    A75    B100   B50   
A50  0.1887 -      -      -      -     
A75  1.0000 1.0000 -      -      -     
B100 0.7223 1.0000 1.0000 -      -     
B50  1.0000 0.0079 0.0929 0.0412 -     
B75  0.6340 1.0000 1.0000 1.0000 0.0350

P value adjustment method: bonferroni </code></pre>
</div>
</div>
<p>These comparisons are a little more difficult to interpret, but the analysis essentially examines for differences among seawater concentrations within species A and for differences among concentrations within species B. We see here that the o2Cons at 50% seawater for species B is significantly different from that of 75% and 100% seawater for species B, whereas there are no significant differences in <code>o2cons</code> for species A across all seawater concentrations.</p>
<p>I find these outputs rather unsatisfying because they show only p-values, but no indication of effect size. One can get both the conclusion from the multiple comparison procedure and an indication of effect size from the graph produced with the following code:</p>
<div class="cell">
<div class="sourceCode" id="cb80"><pre class="sourceCode r cell-code"><code class="sourceCode r"><span id="cb80-1"><a href="#cb80-1" aria-hidden="true" tabindex="-1"></a><span class="co"># fit one-way anova comparing all combinations of species.conc combinations</span></span>
<span id="cb80-2"><a href="#cb80-2" aria-hidden="true" tabindex="-1"></a>anova.modelx <span class="ot">&lt;-</span> <span class="fu">aov</span>(o2cons <span class="sc">~</span> species.conc, <span class="at">data =</span> wmc2dat2)</span>
<span id="cb80-3"><a href="#cb80-3" aria-hidden="true" tabindex="-1"></a>tuk2 <span class="ot">&lt;-</span> <span class="fu">glht</span>(anova.modelx, <span class="at">linfct =</span> <span class="fu">mcp</span>(<span class="at">species.conc =</span> <span class="st">&quot;Tukey&quot;</span>))</span>
<span id="cb80-4"><a href="#cb80-4" aria-hidden="true" tabindex="-1"></a><span class="co"># extract information</span></span>
<span id="cb80-5"><a href="#cb80-5" aria-hidden="true" tabindex="-1"></a>tuk2.cld <span class="ot">&lt;-</span> <span class="fu">cld</span>(tuk2)</span>
<span id="cb80-6"><a href="#cb80-6" aria-hidden="true" tabindex="-1"></a><span class="co"># use sufficiently large upper margin</span></span>
<span id="cb80-7"><a href="#cb80-7" aria-hidden="true" tabindex="-1"></a>old.par <span class="ot">&lt;-</span> <span class="fu">par</span>(<span class="at">mai =</span> <span class="fu">c</span>(<span class="dv">1</span>, <span class="dv">1</span>, <span class="fl">1.25</span>, <span class="dv">1</span>))</span>
<span id="cb80-8"><a href="#cb80-8" aria-hidden="true" tabindex="-1"></a><span class="co"># plot</span></span>
<span id="cb80-9"><a href="#cb80-9" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(tuk2.cld)</span></code></pre></div>
<div class="cell-output-display">
<div>
<figure>
<p><img src="06-anova_mult_files/figure-html/unnamed-chunk-44-1.png" class="img-fluid" width="672" /></p>
</figure>
</div>
</div>
<div class="sourceCode" id="cb81"><pre class="sourceCode r cell-code"><code class="sourceCode r"><span id="cb81-1"><a href="#cb81-1" aria-hidden="true" tabindex="-1"></a><span class="fu">par</span>(old.par)</span></code></pre></div>
</div>
<p>Note that in this analysis, we have used the error MS = 9.474 from the original model to contrast cell means. Recall, however, that this assumes that in fact we are dealing with a Model I ANOVA, which may or may not be the case ( conc is certainly a fixed factor, but species might be either fixed or random).</p>
</section>
<section id="test-de-permutation-pour-lanova-√†-deux-facteurs-de-classification" class="level2" data-number="12.7">
<h2 data-number="12.7"><span class="header-section-number">12.7</span> Test de permutation pour l‚ÄôANOVA √† deux facteurs de classification</h2>
<p>When data do not meet the assumptions of the parametric analysis in two- and multiway ANOVA, as an alternative to the non-parametric ANOVA, it is possible to run permutation tests to calculate p-values. The lmPerm package does this easily.</p>
<div class="cell">
<div class="sourceCode" id="cb82"><pre class="sourceCode r cell-code"><code class="sourceCode r"><span id="cb82-1"><a href="#cb82-1" aria-hidden="true" tabindex="-1"></a><span class="do">#######################################################################</span></span>
<span id="cb82-2"><a href="#cb82-2" aria-hidden="true" tabindex="-1"></a><span class="do">## lmPerm version of permutation test</span></span>
<span id="cb82-3"><a href="#cb82-3" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(lmPerm)</span>
<span id="cb82-4"><a href="#cb82-4" aria-hidden="true" tabindex="-1"></a><span class="co"># for generality, copy desired dataframe to mydata</span></span>
<span id="cb82-5"><a href="#cb82-5" aria-hidden="true" tabindex="-1"></a><span class="co"># and model formula to myformula</span></span>
<span id="cb82-6"><a href="#cb82-6" aria-hidden="true" tabindex="-1"></a>mydata <span class="ot">&lt;-</span> Stu2wdat</span>
<span id="cb82-7"><a href="#cb82-7" aria-hidden="true" tabindex="-1"></a>myformula <span class="ot">&lt;-</span> <span class="fu">as.formula</span>(<span class="st">&quot;rdwght ~ sex+location+sex:location&quot;</span>)</span>
<span id="cb82-8"><a href="#cb82-8" aria-hidden="true" tabindex="-1"></a><span class="co"># Fit desired model on the desired dataframe</span></span>
<span id="cb82-9"><a href="#cb82-9" aria-hidden="true" tabindex="-1"></a>mymodel <span class="ot">&lt;-</span> <span class="fu">lm</span>(myformula, <span class="at">data =</span> mydata)</span>
<span id="cb82-10"><a href="#cb82-10" aria-hidden="true" tabindex="-1"></a><span class="co"># Calculate permutation p-value</span></span>
<span id="cb82-11"><a href="#cb82-11" aria-hidden="true" tabindex="-1"></a><span class="fu">anova</span>(<span class="fu">lmp</span>(myformula, <span class="at">data =</span> mydata, <span class="at">perm =</span> <span class="st">&quot;Prob&quot;</span>, <span class="at">center =</span> <span class="cn">FALSE</span>, <span class="at">Ca =</span> <span class="fl">0.001</span>))</span></code></pre></div>
</div>
<p><code>lmPerm</code> was orphaned for a while and the code below, while clunkier, provided an alternative way of doing it. You would have to adapt it for other situations.</p>
<div class="cell">
<div class="sourceCode" id="cb83"><pre class="sourceCode r cell-code"><code class="sourceCode r"><span id="cb83-1"><a href="#cb83-1" aria-hidden="true" tabindex="-1"></a><span class="do">###########################################################</span></span>
<span id="cb83-2"><a href="#cb83-2" aria-hidden="true" tabindex="-1"></a><span class="co"># Permutation test for two way ANOVA</span></span>
<span id="cb83-3"><a href="#cb83-3" aria-hidden="true" tabindex="-1"></a><span class="co"># Ter Braak creates residuals from cell means and then permutes across</span></span>
<span id="cb83-4"><a href="#cb83-4" aria-hidden="true" tabindex="-1"></a><span class="co"># all cells</span></span>
<span id="cb83-5"><a href="#cb83-5" aria-hidden="true" tabindex="-1"></a><span class="co"># This can be accomplished by taking residuals from the full model</span></span>
<span id="cb83-6"><a href="#cb83-6" aria-hidden="true" tabindex="-1"></a><span class="co"># modified from code written by David C. Howell</span></span>
<span id="cb83-7"><a href="#cb83-7" aria-hidden="true" tabindex="-1"></a><span class="co"># http://www.uvm.edu/~dhowell/StatPages/More_Stuff/Permutation%20Anova/PermTestsAnova.html</span></span>
<span id="cb83-8"><a href="#cb83-8" aria-hidden="true" tabindex="-1"></a>nreps <span class="ot">&lt;-</span> <span class="dv">500</span></span>
<span id="cb83-9"><a href="#cb83-9" aria-hidden="true" tabindex="-1"></a>dependent <span class="ot">&lt;-</span> Stu2wdat<span class="sc">$</span>rdwght</span>
<span id="cb83-10"><a href="#cb83-10" aria-hidden="true" tabindex="-1"></a>factor1 <span class="ot">&lt;-</span> <span class="fu">as.factor</span>(Stu2wdat<span class="sc">$</span>sex)</span>
<span id="cb83-11"><a href="#cb83-11" aria-hidden="true" tabindex="-1"></a>factor2 <span class="ot">&lt;-</span> <span class="fu">as.factor</span>(Stu2wdat<span class="sc">$</span>location)</span>
<span id="cb83-12"><a href="#cb83-12" aria-hidden="true" tabindex="-1"></a>my.dataframe <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(dependent, factor1, factor2)</span>
<span id="cb83-13"><a href="#cb83-13" aria-hidden="true" tabindex="-1"></a>my.dataframe.noNA <span class="ot">&lt;-</span> my.dataframe[<span class="fu">complete.cases</span>(my.dataframe), ]</span>
<span id="cb83-14"><a href="#cb83-14" aria-hidden="true" tabindex="-1"></a>mod <span class="ot">&lt;-</span> <span class="fu">lm</span>(dependent <span class="sc">~</span> factor1 <span class="sc">+</span> factor2 <span class="sc">+</span> factor1<span class="sc">:</span>factor2,</span>
<span id="cb83-15"><a href="#cb83-15" aria-hidden="true" tabindex="-1"></a>  <span class="at">data =</span> my.dataframe.noNA</span>
<span id="cb83-16"><a href="#cb83-16" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb83-17"><a href="#cb83-17" aria-hidden="true" tabindex="-1"></a>res <span class="ot">&lt;-</span> mod<span class="sc">$</span>residuals</span>
<span id="cb83-18"><a href="#cb83-18" aria-hidden="true" tabindex="-1"></a>TBint <span class="ot">&lt;-</span> <span class="fu">numeric</span>(nreps)</span>
<span id="cb83-19"><a href="#cb83-19" aria-hidden="true" tabindex="-1"></a>TB1 <span class="ot">&lt;-</span> <span class="fu">numeric</span>(nreps)</span>
<span id="cb83-20"><a href="#cb83-20" aria-hidden="true" tabindex="-1"></a>TB2 <span class="ot">&lt;-</span> <span class="fu">numeric</span>(nreps)</span>
<span id="cb83-21"><a href="#cb83-21" aria-hidden="true" tabindex="-1"></a>ANOVA <span class="ot">&lt;-</span> <span class="fu">summary</span>(<span class="fu">aov</span>(mod))</span>
<span id="cb83-22"><a href="#cb83-22" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(</span>
<span id="cb83-23"><a href="#cb83-23" aria-hidden="true" tabindex="-1"></a>  <span class="st">&quot; The standard ANOVA for these data follows &quot;</span>,</span>
<span id="cb83-24"><a href="#cb83-24" aria-hidden="true" tabindex="-1"></a>  <span class="st">&quot;</span><span class="sc">\n</span><span class="st">&quot;</span></span>
<span id="cb83-25"><a href="#cb83-25" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb83-26"><a href="#cb83-26" aria-hidden="true" tabindex="-1"></a>F1 <span class="ot">&lt;-</span> ANOVA[[<span class="dv">1</span>]]<span class="sc">$</span><span class="st">&quot;F value&quot;</span>[<span class="dv">1</span>]</span>
<span id="cb83-27"><a href="#cb83-27" aria-hidden="true" tabindex="-1"></a>F2 <span class="ot">&lt;-</span> ANOVA[[<span class="dv">1</span>]]<span class="sc">$</span><span class="st">&quot;F value&quot;</span>[<span class="dv">2</span>]</span>
<span id="cb83-28"><a href="#cb83-28" aria-hidden="true" tabindex="-1"></a>Finteract <span class="ot">&lt;-</span> ANOVA[[<span class="dv">1</span>]]<span class="sc">$</span><span class="st">&quot;F value&quot;</span>[<span class="dv">3</span>]</span>
<span id="cb83-29"><a href="#cb83-29" aria-hidden="true" tabindex="-1"></a><span class="fu">print</span>(ANOVA)</span>
<span id="cb83-30"><a href="#cb83-30" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">&quot;</span><span class="sc">\n</span><span class="st">&quot;</span>)</span>
<span id="cb83-31"><a href="#cb83-31" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">&quot;</span><span class="sc">\n</span><span class="st">&quot;</span>)</span>
<span id="cb83-32"><a href="#cb83-32" aria-hidden="true" tabindex="-1"></a>TBint[<span class="dv">1</span>] <span class="ot">&lt;-</span> Finteract</span>
<span id="cb83-33"><a href="#cb83-33" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> (i <span class="cf">in</span> <span class="dv">2</span><span class="sc">:</span>nreps) {</span>
<span id="cb83-34"><a href="#cb83-34" aria-hidden="true" tabindex="-1"></a>  newdat <span class="ot">&lt;-</span> <span class="fu">sample</span>(res, <span class="fu">length</span>(res), <span class="at">replace =</span> <span class="cn">FALSE</span>)</span>
<span id="cb83-35"><a href="#cb83-35" aria-hidden="true" tabindex="-1"></a>  modb <span class="ot">&lt;-</span> <span class="fu">summary</span>(<span class="fu">aov</span>(newdat <span class="sc">~</span> factor1 <span class="sc">+</span> factor2 <span class="sc">+</span></span>
<span id="cb83-36"><a href="#cb83-36" aria-hidden="true" tabindex="-1"></a>    factor1<span class="sc">:</span>factor2,</span>
<span id="cb83-37"><a href="#cb83-37" aria-hidden="true" tabindex="-1"></a>  <span class="at">data =</span> my.dataframe.noNA</span>
<span id="cb83-38"><a href="#cb83-38" aria-hidden="true" tabindex="-1"></a>  ))</span>
<span id="cb83-39"><a href="#cb83-39" aria-hidden="true" tabindex="-1"></a>  TBint[i] <span class="ot">&lt;-</span> modb[[<span class="dv">1</span>]]<span class="sc">$</span><span class="st">&quot;F value&quot;</span>[<span class="dv">3</span>]</span>
<span id="cb83-40"><a href="#cb83-40" aria-hidden="true" tabindex="-1"></a>  TB1[i] <span class="ot">&lt;-</span> modb[[<span class="dv">1</span>]]<span class="sc">$</span><span class="st">&quot;F value&quot;</span>[<span class="dv">1</span>]</span>
<span id="cb83-41"><a href="#cb83-41" aria-hidden="true" tabindex="-1"></a>  TB2[i] <span class="ot">&lt;-</span> modb[[<span class="dv">1</span>]]<span class="sc">$</span><span class="st">&quot;F value&quot;</span>[<span class="dv">2</span>]</span>
<span id="cb83-42"><a href="#cb83-42" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb83-43"><a href="#cb83-43" aria-hidden="true" tabindex="-1"></a>probInt <span class="ot">&lt;-</span> <span class="fu">length</span>(TBint[TBint <span class="sc">&gt;=</span> Finteract]) <span class="sc">/</span> nreps</span>
<span id="cb83-44"><a href="#cb83-44" aria-hidden="true" tabindex="-1"></a>prob1 <span class="ot">&lt;-</span> <span class="fu">length</span>(TB1[TB1 <span class="sc">&gt;=</span> F1]) <span class="sc">/</span> nreps</span>
<span id="cb83-45"><a href="#cb83-45" aria-hidden="true" tabindex="-1"></a>prob2 <span class="ot">&lt;-</span> <span class="fu">length</span>(TB2[TB1 <span class="sc">&gt;=</span> F2]) <span class="sc">/</span> nreps</span>
<span id="cb83-46"><a href="#cb83-46" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">&quot;</span><span class="sc">\n</span><span class="st">&quot;</span>)</span>
<span id="cb83-47"><a href="#cb83-47" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">&quot;</span><span class="sc">\n</span><span class="st">&quot;</span>)</span>
<span id="cb83-48"><a href="#cb83-48" aria-hidden="true" tabindex="-1"></a><span class="fu">print</span>(<span class="st">&quot;Resampling as in ter Braak with unrestricted sampling</span></span>
<span id="cb83-49"><a href="#cb83-49" aria-hidden="true" tabindex="-1"></a><span class="st">of cell residuals. &quot;</span>)</span>
<span id="cb83-50"><a href="#cb83-50" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(</span>
<span id="cb83-51"><a href="#cb83-51" aria-hidden="true" tabindex="-1"></a>  <span class="st">&quot;The probability for the effect of Interaction is &quot;</span>,</span>
<span id="cb83-52"><a href="#cb83-52" aria-hidden="true" tabindex="-1"></a>  probInt, <span class="st">&quot;</span><span class="sc">\n</span><span class="st">&quot;</span></span>
<span id="cb83-53"><a href="#cb83-53" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb83-54"><a href="#cb83-54" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(</span>
<span id="cb83-55"><a href="#cb83-55" aria-hidden="true" tabindex="-1"></a>  <span class="st">&quot;The probability for the effect of Factor 1 is &quot;</span>,</span>
<span id="cb83-56"><a href="#cb83-56" aria-hidden="true" tabindex="-1"></a>  prob1, <span class="st">&quot;</span><span class="sc">\n</span><span class="st">&quot;</span></span>
<span id="cb83-57"><a href="#cb83-57" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb83-58"><a href="#cb83-58" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(</span>
<span id="cb83-59"><a href="#cb83-59" aria-hidden="true" tabindex="-1"></a>  <span class="st">&quot;The probability for the effect of Factor 2 is &quot;</span>,</span>
<span id="cb83-60"><a href="#cb83-60" aria-hidden="true" tabindex="-1"></a>  prob2, <span class="st">&quot;</span><span class="sc">\n</span><span class="st">&quot;</span></span>
<span id="cb83-61"><a href="#cb83-61" aria-hidden="true" tabindex="-1"></a>)</span></code></pre></div>
</div>
</section>
<section id="bootstrap-for-two-way-anova" class="level2" data-number="12.8">
<h2 data-number="12.8"><span class="header-section-number">12.8</span> Bootstrap for two-way ANOVA</h2>
<p>In most cases, permutation tests will be more appropriate than bootstrap in ANOVA designs. However, for the sake of completedness, I have a snippet of code to do bootstrap for you::</p>
<div class="cell">
<div class="sourceCode" id="cb84"><pre class="sourceCode r cell-code"><code class="sourceCode r"><span id="cb84-1"><a href="#cb84-1" aria-hidden="true" tabindex="-1"></a><span class="do">############################################################</span></span>
<span id="cb84-2"><a href="#cb84-2" aria-hidden="true" tabindex="-1"></a><span class="do">###########</span></span>
<span id="cb84-3"><a href="#cb84-3" aria-hidden="true" tabindex="-1"></a><span class="co"># Bootstrap for two-way ANOVA</span></span>
<span id="cb84-4"><a href="#cb84-4" aria-hidden="true" tabindex="-1"></a><span class="co"># You possibly want to edit bootfunction.mod1 to return other values</span></span>
<span id="cb84-5"><a href="#cb84-5" aria-hidden="true" tabindex="-1"></a><span class="co"># Here it returns the standard coefficients of the fitted model</span></span>
<span id="cb84-6"><a href="#cb84-6" aria-hidden="true" tabindex="-1"></a><span class="co"># Requires boot library</span></span>
<span id="cb84-7"><a href="#cb84-7" aria-hidden="true" tabindex="-1"></a><span class="co">#</span></span>
<span id="cb84-8"><a href="#cb84-8" aria-hidden="true" tabindex="-1"></a>nreps <span class="ot">&lt;-</span> <span class="dv">5000</span></span>
<span id="cb84-9"><a href="#cb84-9" aria-hidden="true" tabindex="-1"></a>dependent <span class="ot">&lt;-</span> Stu2wdat<span class="sc">$</span>rdwght</span>
<span id="cb84-10"><a href="#cb84-10" aria-hidden="true" tabindex="-1"></a>factor1 <span class="ot">&lt;-</span> <span class="fu">as.factor</span>(Stu2wdat<span class="sc">$</span>sex)</span>
<span id="cb84-11"><a href="#cb84-11" aria-hidden="true" tabindex="-1"></a>factor2 <span class="ot">&lt;-</span> <span class="fu">as.factor</span>(Stu2wdat<span class="sc">$</span>location)</span>
<span id="cb84-12"><a href="#cb84-12" aria-hidden="true" tabindex="-1"></a>my.dataframe <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(dependent, factor1, factor2)</span>
<span id="cb84-13"><a href="#cb84-13" aria-hidden="true" tabindex="-1"></a>my.dataframe.noNA <span class="ot">&lt;-</span> my.dataframe[<span class="fu">complete.cases</span>(my.dataframe), ]</span>
<span id="cb84-14"><a href="#cb84-14" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(boot)</span>
<span id="cb84-15"><a href="#cb84-15" aria-hidden="true" tabindex="-1"></a><span class="co"># Fit model on observed data</span></span>
<span id="cb84-16"><a href="#cb84-16" aria-hidden="true" tabindex="-1"></a>mod1 <span class="ot">&lt;-</span> <span class="fu">aov</span>(dependent <span class="sc">~</span> factor1 <span class="sc">+</span> factor2 <span class="sc">+</span> factor1<span class="sc">:</span>factor2,</span>
<span id="cb84-17"><a href="#cb84-17" aria-hidden="true" tabindex="-1"></a>  <span class="at">data =</span> my.dataframe.noNA</span>
<span id="cb84-18"><a href="#cb84-18" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb84-19"><a href="#cb84-19" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb84-20"><a href="#cb84-20" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb84-21"><a href="#cb84-21" aria-hidden="true" tabindex="-1"></a><span class="co"># Bootstrap 1000 time using the residuals bootstraping methods to</span></span>
<span id="cb84-22"><a href="#cb84-22" aria-hidden="true" tabindex="-1"></a><span class="co"># keep the same unequal number of observations for each level of the indep. var.</span></span>
<span id="cb84-23"><a href="#cb84-23" aria-hidden="true" tabindex="-1"></a>fit <span class="ot">&lt;-</span> <span class="fu">fitted</span>(mod1)</span>
<span id="cb84-24"><a href="#cb84-24" aria-hidden="true" tabindex="-1"></a>e <span class="ot">&lt;-</span> <span class="fu">residuals</span>(mod1)</span>
<span id="cb84-25"><a href="#cb84-25" aria-hidden="true" tabindex="-1"></a>X <span class="ot">&lt;-</span> <span class="fu">model.matrix</span>(mod1)</span>
<span id="cb84-26"><a href="#cb84-26" aria-hidden="true" tabindex="-1"></a>bootfunction.mod1 <span class="ot">&lt;-</span> <span class="cf">function</span>(data, indices) {</span>
<span id="cb84-27"><a href="#cb84-27" aria-hidden="true" tabindex="-1"></a>  y <span class="ot">&lt;-</span> fit <span class="sc">+</span> e[indices]</span>
<span id="cb84-28"><a href="#cb84-28" aria-hidden="true" tabindex="-1"></a>  bootmod <span class="ot">&lt;-</span> <span class="fu">lm</span>(y <span class="sc">~</span> X)</span>
<span id="cb84-29"><a href="#cb84-29" aria-hidden="true" tabindex="-1"></a>  <span class="fu">coefficients</span>(bootmod)</span>
<span id="cb84-30"><a href="#cb84-30" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb84-31"><a href="#cb84-31" aria-hidden="true" tabindex="-1"></a>bootresults <span class="ot">&lt;-</span> <span class="fu">boot</span>(my.dataframe.noNA, bootfunction.mod1,</span>
<span id="cb84-32"><a href="#cb84-32" aria-hidden="true" tabindex="-1"></a>  <span class="at">R =</span> <span class="dv">1000</span></span>
<span id="cb84-33"><a href="#cb84-33" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb84-34"><a href="#cb84-34" aria-hidden="true" tabindex="-1"></a>bootresults</span>
<span id="cb84-35"><a href="#cb84-35" aria-hidden="true" tabindex="-1"></a><span class="do">## Calculate 90% CI and plot bootstrap estimates separately for each model parameter</span></span>
<span id="cb84-36"><a href="#cb84-36" aria-hidden="true" tabindex="-1"></a><span class="fu">boot.ci</span>(bootresults, <span class="at">conf =</span> <span class="fl">0.9</span>, <span class="at">index =</span> <span class="dv">1</span>)</span>
<span id="cb84-37"><a href="#cb84-37" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(bootresults, <span class="at">index =</span> <span class="dv">1</span>)</span>
<span id="cb84-38"><a href="#cb84-38" aria-hidden="true" tabindex="-1"></a><span class="fu">boot.ci</span>(bootresults, <span class="at">conf =</span> <span class="fl">0.9</span>, <span class="at">index =</span> <span class="dv">3</span>)</span>
<span id="cb84-39"><a href="#cb84-39" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(bootresults, <span class="at">index =</span> <span class="dv">3</span>)</span>
<span id="cb84-40"><a href="#cb84-40" aria-hidden="true" tabindex="-1"></a><span class="fu">boot.ci</span>(bootresults, <span class="at">conf =</span> <span class="fl">0.9</span>, <span class="at">index =</span> <span class="dv">4</span>)</span>
<span id="cb84-41"><a href="#cb84-41" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(bootresults, <span class="at">index =</span> <span class="dv">4</span>)</span>
<span id="cb84-42"><a href="#cb84-42" aria-hidden="true" tabindex="-1"></a><span class="fu">boot.ci</span>(bootresults, <span class="at">conf =</span> <span class="fl">0.9</span>, <span class="at">index =</span> <span class="dv">5</span>)</span>
<span id="cb84-43"><a href="#cb84-43" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(bootresults, <span class="at">index =</span> <span class="dv">5</span>)</span></code></pre></div>
</div>
<div id="quarto-navigation-envelope" class="hidden">
<p><span class="hidden" data-render-id="quarto-int-sidebar-title">On the R-way to hell</span> <span class="hidden" data-render-id="quarto-int-navbar-title"><img src="images/cover/book_hex_en.png" class="img-fluid" width="50" /> R Way</span> <span class="hidden" data-render-id="quarto-int-next"><span class="chapter-number">13</span>¬† <span class="chapter-title">Multiple regression</span></span> <span class="hidden" data-render-id="quarto-int-prev"><span class="chapter-number">11</span>¬† <span class="chapter-title">One-way ANOVA</span></span> <span class="hidden" data-render-id="quarto-int-sidebar:/index.htmlPreface">Preface</span> <span class="hidden" data-render-id="quarto-int-sidebar:quarto-sidebar-section-1">Using R</span> <span class="hidden" data-render-id="quarto-int-sidebar:/01-start.html&lt;span-class=&#39;chapter-number&#39;&gt;1&lt;/span&gt;--&lt;span-class=&#39;chapter-title&#39;&gt;Getting-started&lt;/span&gt;"><span class="chapter-number">1</span>¬† <span class="chapter-title">Getting started</span></span> <span class="hidden" data-render-id="quarto-int-sidebar:/02-basics.html&lt;span-class=&#39;chapter-number&#39;&gt;2&lt;/span&gt;--&lt;span-class=&#39;chapter-title&#39;&gt;Some-R-basics&lt;/span&gt;"><span class="chapter-number">2</span>¬† <span class="chapter-title">Some R basics</span></span> <span class="hidden" data-render-id="quarto-int-sidebar:/03-data.html&lt;span-class=&#39;chapter-number&#39;&gt;3&lt;/span&gt;--&lt;span-class=&#39;chapter-title&#39;&gt;Data&lt;/span&gt;"><span class="chapter-number">3</span>¬† <span class="chapter-title">Data</span></span> <span class="hidden" data-render-id="quarto-int-sidebar:/04-graphics_short.html&lt;span-class=&#39;chapter-number&#39;&gt;4&lt;/span&gt;--&lt;span-class=&#39;chapter-title&#39;&gt;Figures&lt;/span&gt;"><span class="chapter-number">4</span>¬† <span class="chapter-title">Figures</span></span> <span class="hidden" data-render-id="quarto-int-sidebar:/05-programming.html&lt;span-class=&#39;chapter-number&#39;&gt;5&lt;/span&gt;--&lt;span-class=&#39;chapter-title&#39;&gt;Programming&lt;/span&gt;"><span class="chapter-number">5</span>¬† <span class="chapter-title">Programming</span></span> <span class="hidden" data-render-id="quarto-int-sidebar:/06-quarto.html&lt;span-class=&#39;chapter-number&#39;&gt;6&lt;/span&gt;--&lt;span-class=&#39;chapter-title&#39;&gt;Reproducible-reports-with-Quarto&lt;/span&gt;"><span class="chapter-number">6</span>¬† <span class="chapter-title">Reproducible reports with Quarto</span></span> <span class="hidden" data-render-id="quarto-int-sidebar:/07-github.html&lt;span-class=&#39;chapter-number&#39;&gt;7&lt;/span&gt;--&lt;span-class=&#39;chapter-title&#39;&gt;Version-control-with-Git-and-GitHub&lt;/span&gt;"><span class="chapter-number">7</span>¬† <span class="chapter-title">Version control with Git and GitHub</span></span> <span class="hidden" data-render-id="quarto-int-sidebar:quarto-sidebar-section-2">Fundamentals of stats</span> <span class="hidden" data-render-id="quarto-int-sidebar:/25-power.html&lt;span-class=&#39;chapter-number&#39;&gt;8&lt;/span&gt;--&lt;span-class=&#39;chapter-title&#39;&gt;Power-Analysis-with-R-and-G*Power&lt;/span&gt;"><span class="chapter-number">8</span>¬† <span class="chapter-title">Power Analysis with R and G*Power</span></span> <span class="hidden" data-render-id="quarto-int-sidebar:quarto-sidebar-section-3">Linear models</span> <span class="hidden" data-render-id="quarto-int-sidebar:/31-reg_lin.html&lt;span-class=&#39;chapter-number&#39;&gt;9&lt;/span&gt;--&lt;span-class=&#39;chapter-title&#39;&gt;Correlation-and-simple-linear-regression&lt;/span&gt;"><span class="chapter-number">9</span>¬† <span class="chapter-title">Correlation and simple linear regression</span></span> <span class="hidden" data-render-id="quarto-int-sidebar:/32-t_test.html&lt;span-class=&#39;chapter-number&#39;&gt;10&lt;/span&gt;--&lt;span-class=&#39;chapter-title&#39;&gt;Two---sample-comparisons&lt;/span&gt;"><span class="chapter-number">10</span>¬† <span class="chapter-title">Two - sample comparisons</span></span> <span class="hidden" data-render-id="quarto-int-sidebar:/33-anova.html&lt;span-class=&#39;chapter-number&#39;&gt;11&lt;/span&gt;--&lt;span-class=&#39;chapter-title&#39;&gt;One-way-ANOVA&lt;/span&gt;"><span class="chapter-number">11</span>¬† <span class="chapter-title">One-way ANOVA</span></span> <span class="hidden" data-render-id="quarto-int-sidebar:/06-anova_mult.html&lt;span-class=&#39;chapter-number&#39;&gt;12&lt;/span&gt;--&lt;span-class=&#39;chapter-title&#39;&gt;Multiway-ANOVA:-factorial-and-nested-designs&lt;/span&gt;"><span class="chapter-number">12</span>¬† <span class="chapter-title">Multiway ANOVA: factorial and nested designs</span></span> <span class="hidden" data-render-id="quarto-int-sidebar:/35-reg_mult.html&lt;span-class=&#39;chapter-number&#39;&gt;13&lt;/span&gt;--&lt;span-class=&#39;chapter-title&#39;&gt;Multiple-regression&lt;/span&gt;"><span class="chapter-number">13</span>¬† <span class="chapter-title">Multiple regression</span></span> <span class="hidden" data-render-id="quarto-int-sidebar:/36-ancova_glm.html&lt;span-class=&#39;chapter-number&#39;&gt;14&lt;/span&gt;--&lt;span-class=&#39;chapter-title&#39;&gt;ANCOVA-and-general-linear-model&lt;/span&gt;"><span class="chapter-number">14</span>¬† <span class="chapter-title">ANCOVA and general linear model</span></span> <span class="hidden" data-render-id="quarto-int-sidebar:/37-model_freq.html&lt;span-class=&#39;chapter-number&#39;&gt;15&lt;/span&gt;--&lt;span-class=&#39;chapter-title&#39;&gt;Analysis-of-frequency-data:-Contingency-Tables,-Log-Linear-Models,-and-Poisson-Regression&lt;/span&gt;"><span class="chapter-number">15</span>¬† <span class="chapter-title">Analysis of frequency data: Contingency Tables, Log-Linear Models, and Poisson Regression</span></span> <span class="hidden" data-render-id="quarto-int-sidebar:quarto-sidebar-section-4">Generalized linear models</span> <span class="hidden" data-render-id="quarto-int-sidebar:quarto-sidebar-section-5">Mixed models</span> <span class="hidden" data-render-id="quarto-int-sidebar:quarto-sidebar-section-6">Generalized additive models</span> <span class="hidden" data-render-id="quarto-int-sidebar:quarto-sidebar-section-7">Multivariate analysis</span> <span class="hidden" data-render-id="quarto-int-sidebar:quarto-sidebar-section-8">Bayesian approach</span> <span class="hidden" data-render-id="quarto-int-sidebar:/901-references.htmlReferences">References</span> <span class="hidden" data-render-id="quarto-int-sidebar:quarto-sidebar-section-9">Appendices</span> <span class="hidden" data-render-id="quarto-int-sidebar:/902-data-files.html&lt;span-class=&#39;chapter-number&#39;&gt;A&lt;/span&gt;--&lt;span-class=&#39;chapter-title&#39;&gt;Data-used-in-this-book&lt;/span&gt;"><span class="chapter-number">A</span>¬† <span class="chapter-title">Data used in this book</span></span> <span class="hidden" data-render-id="quarto-int-sidebar:/903-latex.html&lt;span-class=&#39;chapter-number&#39;&gt;B&lt;/span&gt;--&lt;span-class=&#39;chapter-title&#39;&gt;Installing-Quarto-and-LateX&lt;/span&gt;"><span class="chapter-number">B</span>¬† <span class="chapter-title">Installing Quarto and LateX</span></span> <span class="hidden" data-render-id="quarto-int-navbar:Data">Data</span> <span class="hidden" data-render-id="quarto-int-navbar:/902-data-files.html">/902-data-files.html</span> <span class="hidden" data-render-id="quarto-int-navbar:Other resources">Other resources</span> <span class="hidden" data-render-id="quarto-int-navbar:Biostats uOttawa">Biostats uOttawa</span> <span class="hidden" data-render-id="quarto-int-navbar:https://biostats-uottawa.github.io/">https://biostats-uottawa.github.io/</span> <span class="hidden" data-render-id="quarto-int-navbar:Biostats with R (Bio4158)">Biostats with R (Bio4158)</span> <span class="hidden" data-render-id="quarto-int-navbar:https://biostats-uottawa.github.io/bio4158_course/">https://biostats-uottawa.github.io/bio4158_course/</span> <span class="hidden" data-render-id="quarto-int-navbar:Biostats avec R (Bio4558)">Biostats avec R (Bio4558)</span> <span class="hidden" data-render-id="quarto-int-navbar:https://biostats-uottawa.github.io/bio4558_cours/">https://biostats-uottawa.github.io/bio4558_cours/</span> <span class="hidden" data-render-id="quarto-int-navbar:Advanced biostats and open science (Bio8940)">Advanced biostats and open science (Bio8940)</span> <span class="hidden" data-render-id="quarto-int-navbar:https://biostats-uottawa.github.io/bio8940_course/">https://biostats-uottawa.github.io/bio8940_course/</span> <span class="hidden" data-render-id="quarto-int-navbar:Fran√ßais">Fran√ßais</span> <span class="hidden" data-render-id="quarto-int-navbar:/../fr">/../fr</span> <span class="hidden" data-render-id="quarto-navbar-tools:https://github.com/biostats-uottawa/R_way/">https://github.com/biostats-uottawa/R_way/</span> <span class="hidden" data-render-id="quarto-breadcrumbs-Linear-models">Linear models</span> <span class="hidden" data-render-id="quarto-breadcrumbs-&lt;span-class=&#39;chapter-number&#39;&gt;12&lt;/span&gt;--&lt;span-class=&#39;chapter-title&#39;&gt;Multiway-ANOVA:-factorial-and-nested-designs&lt;/span&gt;"><span class="chapter-number">12</span>¬† <span class="chapter-title">Multiway ANOVA: factorial and nested designs</span></span></p>
<div class="hidden" data-render-id="footer-left">
<p><a href="https://biostats-uottawa.github.io/people.html">Julien Martin</a></p>
</div>
<div class="hidden" data-render-id="footer-right">
<p>This book was built with <a href="https://quarto.org/">Quarto</a>.</p>
</div>
</div>
<div id="quarto-meta-markdown" class="hidden">
<p><span class="hidden" data-render-id="quarto-metatitle">On the R-way to hell - <span class="chapter-number">12</span>¬† <span class="chapter-title">Multiway ANOVA: factorial and nested designs</span></span> <span class="hidden" data-render-id="quarto-twittercardtitle">On the R-way to hell - <span class="chapter-number">12</span>¬† <span class="chapter-title">Multiway ANOVA: factorial and nested designs</span></span> <span class="hidden" data-render-id="quarto-ogcardtitle">On the R-way to hell - <span class="chapter-number">12</span>¬† <span class="chapter-title">Multiway ANOVA: factorial and nested designs</span></span> <span class="hidden" data-render-id="quarto-metasitename">On the R-way to hell</span> <span class="hidden" data-render-id="quarto-twittercarddesc">Early version needed to be severely updated/modified</span> <span class="hidden" data-render-id="quarto-ogcardddesc">Early version needed to be severely updated/modified</span></p>
</div>
</section>

</main> <!-- /main -->
<script id = "quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();  
  const disableStylesheet = (stylesheets) => {
    for (let i=0; i < stylesheets.length; i++) {
      const stylesheet = stylesheets[i];
      stylesheet.rel = 'prefetch';
    }
  }
  const enableStylesheet = (stylesheets) => {
    for (let i=0; i < stylesheets.length; i++) {
      const stylesheet = stylesheets[i];
      stylesheet.rel = 'stylesheet';
    }
  }
  const manageTransitions = (selector, allowTransitions) => {
    const els = window.document.querySelectorAll(selector);
    for (let i=0; i < els.length; i++) {
      const el = els[i];
      if (allowTransitions) {
        el.classList.remove('notransition');
      } else {
        el.classList.add('notransition');
      }
    }
  }
  const toggleGiscusIfUsed = (isAlternate, darkModeDefault) => {
    const baseTheme = document.querySelector('#giscus-base-theme')?.value ?? 'light';
    const alternateTheme = document.querySelector('#giscus-alt-theme')?.value ?? 'dark';
    let newTheme = '';
    if(darkModeDefault) {
      newTheme = isAlternate ? baseTheme : alternateTheme;
    } else {
      newTheme = isAlternate ? alternateTheme : baseTheme;
    }
    const changeGiscusTheme = () => {
      // From: https://github.com/giscus/giscus/issues/336
      const sendMessage = (message) => {
        const iframe = document.querySelector('iframe.giscus-frame');
        if (!iframe) return;
        iframe.contentWindow.postMessage({ giscus: message }, 'https://giscus.app');
      }
      sendMessage({
        setConfig: {
          theme: newTheme
        }
      });
    }
    const isGiscussLoaded = window.document.querySelector('iframe.giscus-frame') !== null;
    if (isGiscussLoaded) {
      changeGiscusTheme();
    }
  }
  const toggleColorMode = (alternate) => {
    // Switch the stylesheets
    const alternateStylesheets = window.document.querySelectorAll('link.quarto-color-scheme.quarto-color-alternate');
    manageTransitions('#quarto-margin-sidebar .nav-link', false);
    if (alternate) {
      enableStylesheet(alternateStylesheets);
      for (const sheetNode of alternateStylesheets) {
        if (sheetNode.id === "quarto-bootstrap") {
          toggleBodyColorMode(sheetNode);
        }
      }
    } else {
      disableStylesheet(alternateStylesheets);
      toggleBodyColorPrimary();
    }
    manageTransitions('#quarto-margin-sidebar .nav-link', true);
    // Switch the toggles
    const toggles = window.document.querySelectorAll('.quarto-color-scheme-toggle');
    for (let i=0; i < toggles.length; i++) {
      const toggle = toggles[i];
      if (toggle) {
        if (alternate) {
          toggle.classList.add("alternate");     
        } else {
          toggle.classList.remove("alternate");
        }
      }
    }
    // Hack to workaround the fact that safari doesn't
    // properly recolor the scrollbar when toggling (#1455)
    if (navigator.userAgent.indexOf('Safari') > 0 && navigator.userAgent.indexOf('Chrome') == -1) {
      manageTransitions("body", false);
      window.scrollTo(0, 1);
      setTimeout(() => {
        window.scrollTo(0, 0);
        manageTransitions("body", true);
      }, 40);  
    }
  }
  const isFileUrl = () => { 
    return window.location.protocol === 'file:';
  }
  const hasAlternateSentinel = () => {  
    let styleSentinel = getColorSchemeSentinel();
    if (styleSentinel !== null) {
      return styleSentinel === "alternate";
    } else {
      return false;
    }
  }
  const setStyleSentinel = (alternate) => {
    const value = alternate ? "alternate" : "default";
    if (!isFileUrl()) {
      window.localStorage.setItem("quarto-color-scheme", value);
    } else {
      localAlternateSentinel = value;
    }
  }
  const getColorSchemeSentinel = () => {
    if (!isFileUrl()) {
      const storageValue = window.localStorage.getItem("quarto-color-scheme");
      return storageValue != null ? storageValue : localAlternateSentinel;
    } else {
      return localAlternateSentinel;
    }
  }
  const darkModeDefault = false;
  let localAlternateSentinel = darkModeDefault ? 'alternate' : 'default';
  // Dark / light mode switch
  window.quartoToggleColorScheme = () => {
    // Read the current dark / light value 
    let toAlternate = !hasAlternateSentinel();
    toggleColorMode(toAlternate);
    setStyleSentinel(toAlternate);
    toggleGiscusIfUsed(toAlternate, darkModeDefault);
  };
  // Ensure there is a toggle, if there isn't float one in the top right
  if (window.document.querySelector('.quarto-color-scheme-toggle') === null) {
    const a = window.document.createElement('a');
    a.classList.add('top-right');
    a.classList.add('quarto-color-scheme-toggle');
    a.href = "";
    a.onclick = function() { try { window.quartoToggleColorScheme(); } catch {} return false; };
    const i = window.document.createElement("i");
    i.classList.add('bi');
    a.appendChild(i);
    window.document.body.appendChild(a);
  }
  // Switch to dark mode if need be
  if (hasAlternateSentinel()) {
    toggleColorMode(true);
  } else {
    toggleColorMode(false);
  }
  const icon = "Óßã";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const isCodeAnnotation = (el) => {
    for (const clz of el.classList) {
      if (clz.startsWith('code-annotation-')) {                     
        return true;
      }
    }
    return false;
  }
  const onCopySuccess = function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Copied!");
    let tooltip;
    if (window.bootstrap) {
      button.setAttribute("data-bs-toggle", "tooltip");
      button.setAttribute("data-bs-placement", "left");
      button.setAttribute("data-bs-title", "Copied!");
      tooltip = new bootstrap.Tooltip(button, 
        { trigger: "manual", 
          customClass: "code-copy-button-tooltip",
          offset: [0, -8]});
      tooltip.show();    
    }
    setTimeout(function() {
      if (tooltip) {
        tooltip.hide();
        button.removeAttribute("data-bs-title");
        button.removeAttribute("data-bs-toggle");
        button.removeAttribute("data-bs-placement");
      }
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  }
  const getTextToCopy = function(trigger) {
      const codeEl = trigger.previousElementSibling.cloneNode(true);
      for (const childEl of codeEl.children) {
        if (isCodeAnnotation(childEl)) {
          childEl.remove();
        }
      }
      return codeEl.innerText;
  }
  const clipboard = new window.ClipboardJS('.code-copy-button:not([data-in-quarto-modal])', {
    text: getTextToCopy
  });
  clipboard.on('success', onCopySuccess);
  if (window.document.getElementById('quarto-embedded-source-code-modal')) {
    // For code content inside modals, clipBoardJS needs to be initialized with a container option
    // TODO: Check when it could be a function (https://github.com/zenorocha/clipboard.js/issues/860)
    const clipboardModal = new window.ClipboardJS('.code-copy-button[data-in-quarto-modal]', {
      text: getTextToCopy,
      container: window.document.getElementById('quarto-embedded-source-code-modal')
    });
    clipboardModal.on('success', onCopySuccess);
  }
    var localhostRegex = new RegExp(/^(?:http|https):\/\/localhost\:?[0-9]*\//);
    var mailtoRegex = new RegExp(/^mailto:/);
      var filterRegex = new RegExp("https:\/\/biostats-uottawa\.github\.io\/R_way\/");
    var isInternal = (href) => {
        return filterRegex.test(href) || localhostRegex.test(href) || mailtoRegex.test(href);
    }
    // Inspect non-navigation links and adorn them if external
 	var links = window.document.querySelectorAll('a[href]:not(.nav-link):not(.navbar-brand):not(.toc-action):not(.sidebar-link):not(.sidebar-item-toggle):not(.pagination-link):not(.no-external):not([aria-hidden]):not(.dropdown-item):not(.quarto-navigation-tool):not(.about-link)');
    for (var i=0; i<links.length; i++) {
      const link = links[i];
      if (!isInternal(link.href)) {
        // undo the damage that might have been done by quarto-nav.js in the case of
        // links that we want to consider external
        if (link.dataset.originalHref !== undefined) {
          link.href = link.dataset.originalHref;
        }
      }
    }
  function tippyHover(el, contentFn, onTriggerFn, onUntriggerFn) {
    const config = {
      allowHTML: true,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start',
    };
    if (contentFn) {
      config.content = contentFn;
    }
    if (onTriggerFn) {
      config.onTrigger = onTriggerFn;
    }
    if (onUntriggerFn) {
      config.onUntrigger = onUntriggerFn;
    }
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      // use id or data attribute instead here
      let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      if (note) {
        return note.innerHTML;
      } else {
        return "";
      }
    });
  }
  const xrefs = window.document.querySelectorAll('a.quarto-xref');
  const processXRef = (id, note) => {
    // Strip column container classes
    const stripColumnClz = (el) => {
      el.classList.remove("page-full", "page-columns");
      if (el.children) {
        for (const child of el.children) {
          stripColumnClz(child);
        }
      }
    }
    stripColumnClz(note)
    if (id === null || id.startsWith('sec-')) {
      // Special case sections, only their first couple elements
      const container = document.createElement("div");
      if (note.children && note.children.length > 2) {
        container.appendChild(note.children[0].cloneNode(true));
        for (let i = 1; i < note.children.length; i++) {
          const child = note.children[i];
          if (child.tagName === "P" && child.innerText === "") {
            continue;
          } else {
            container.appendChild(child.cloneNode(true));
            break;
          }
        }
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(container);
        }
        return container.innerHTML
      } else {
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(note);
        }
        return note.innerHTML;
      }
    } else {
      // Remove any anchor links if they are present
      const anchorLink = note.querySelector('a.anchorjs-link');
      if (anchorLink) {
        anchorLink.remove();
      }
      if (window.Quarto?.typesetMath) {
        window.Quarto.typesetMath(note);
      }
      // TODO in 1.5, we should make sure this works without a callout special case
      if (note.classList.contains("callout")) {
        return note.outerHTML;
      } else {
        return note.innerHTML;
      }
    }
  }
  for (var i=0; i<xrefs.length; i++) {
    const xref = xrefs[i];
    tippyHover(xref, undefined, function(instance) {
      instance.disable();
      let url = xref.getAttribute('href');
      let hash = undefined; 
      if (url.startsWith('#')) {
        hash = url;
      } else {
        try { hash = new URL(url).hash; } catch {}
      }
      if (hash) {
        const id = hash.replace(/^#\/?/, "");
        const note = window.document.getElementById(id);
        if (note !== null) {
          try {
            const html = processXRef(id, note.cloneNode(true));
            instance.setContent(html);
          } finally {
            instance.enable();
            instance.show();
          }
        } else {
          // See if we can fetch this
          fetch(url.split('#')[0])
          .then(res => res.text())
          .then(html => {
            const parser = new DOMParser();
            const htmlDoc = parser.parseFromString(html, "text/html");
            const note = htmlDoc.getElementById(id);
            if (note !== null) {
              const html = processXRef(id, note);
              instance.setContent(html);
            } 
          }).finally(() => {
            instance.enable();
            instance.show();
          });
        }
      } else {
        // See if we can fetch a full url (with no hash to target)
        // This is a special case and we should probably do some content thinning / targeting
        fetch(url)
        .then(res => res.text())
        .then(html => {
          const parser = new DOMParser();
          const htmlDoc = parser.parseFromString(html, "text/html");
          const note = htmlDoc.querySelector('main.content');
          if (note !== null) {
            // This should only happen for chapter cross references
            // (since there is no id in the URL)
            // remove the first header
            if (note.children.length > 0 && note.children[0].tagName === "HEADER") {
              note.children[0].remove();
            }
            const html = processXRef(null, note);
            instance.setContent(html);
          } 
        }).finally(() => {
          instance.enable();
          instance.show();
        });
      }
    }, function(instance) {
    });
  }
      let selectedAnnoteEl;
      const selectorForAnnotation = ( cell, annotation) => {
        let cellAttr = 'data-code-cell="' + cell + '"';
        let lineAttr = 'data-code-annotation="' +  annotation + '"';
        const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
        return selector;
      }
      const selectCodeLines = (annoteEl) => {
        const doc = window.document;
        const targetCell = annoteEl.getAttribute("data-target-cell");
        const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
        const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
        const lines = annoteSpan.getAttribute("data-code-lines").split(",");
        const lineIds = lines.map((line) => {
          return targetCell + "-" + line;
        })
        let top = null;
        let height = null;
        let parent = null;
        if (lineIds.length > 0) {
            //compute the position of the single el (top and bottom and make a div)
            const el = window.document.getElementById(lineIds[0]);
            top = el.offsetTop;
            height = el.offsetHeight;
            parent = el.parentElement.parentElement;
          if (lineIds.length > 1) {
            const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
            const bottom = lastEl.offsetTop + lastEl.offsetHeight;
            height = bottom - top;
          }
          if (top !== null && height !== null && parent !== null) {
            // cook up a div (if necessary) and position it 
            let div = window.document.getElementById("code-annotation-line-highlight");
            if (div === null) {
              div = window.document.createElement("div");
              div.setAttribute("id", "code-annotation-line-highlight");
              div.style.position = 'absolute';
              parent.appendChild(div);
            }
            div.style.top = top - 2 + "px";
            div.style.height = height + 4 + "px";
            div.style.left = 0;
            let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
            if (gutterDiv === null) {
              gutterDiv = window.document.createElement("div");
              gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
              gutterDiv.style.position = 'absolute';
              const codeCell = window.document.getElementById(targetCell);
              const gutter = codeCell.querySelector('.code-annotation-gutter');
              gutter.appendChild(gutterDiv);
            }
            gutterDiv.style.top = top - 2 + "px";
            gutterDiv.style.height = height + 4 + "px";
          }
          selectedAnnoteEl = annoteEl;
        }
      };
      const unselectCodeLines = () => {
        const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
        elementsIds.forEach((elId) => {
          const div = window.document.getElementById(elId);
          if (div) {
            div.remove();
          }
        });
        selectedAnnoteEl = undefined;
      };
        // Handle positioning of the toggle
    window.addEventListener(
      "resize",
      throttle(() => {
        elRect = undefined;
        if (selectedAnnoteEl) {
          selectCodeLines(selectedAnnoteEl);
        }
      }, 10)
    );
    function throttle(fn, ms) {
    let throttle = false;
    let timer;
      return (...args) => {
        if(!throttle) { // first call gets through
            fn.apply(this, args);
            throttle = true;
        } else { // all the others get throttled
            if(timer) clearTimeout(timer); // cancel #2
            timer = setTimeout(() => {
              fn.apply(this, args);
              timer = throttle = false;
            }, ms);
        }
      };
    }
      // Attach click handler to the DT
      const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
      for (const annoteDlNode of annoteDls) {
        annoteDlNode.addEventListener('click', (event) => {
          const clickedEl = event.target;
          if (clickedEl !== selectedAnnoteEl) {
            unselectCodeLines();
            const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
            if (activeEl) {
              activeEl.classList.remove('code-annotation-active');
            }
            selectCodeLines(clickedEl);
            clickedEl.classList.add('code-annotation-active');
          } else {
            // Unselect the line
            unselectCodeLines();
            clickedEl.classList.remove('code-annotation-active');
          }
        });
      }
  const findCites = (el) => {
    const parentEl = el.parentElement;
    if (parentEl) {
      const cites = parentEl.dataset.cites;
      if (cites) {
        return {
          el,
          cites: cites.split(' ')
        };
      } else {
        return findCites(el.parentElement)
      }
    } else {
      return undefined;
    }
  };
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const citeInfo = findCites(ref);
    if (citeInfo) {
      tippyHover(citeInfo.el, function() {
        var popup = window.document.createElement('div');
        citeInfo.cites.forEach(function(cite) {
          var citeDiv = window.document.createElement('div');
          citeDiv.classList.add('hanging-indent');
          citeDiv.classList.add('csl-entry');
          var biblioDiv = window.document.getElementById('ref-' + cite);
          if (biblioDiv) {
            citeDiv.innerHTML = biblioDiv.innerHTML;
          }
          popup.appendChild(citeDiv);
        });
        return popup.innerHTML;
      });
    }
  }
});
</script>
<nav class="page-navigation">
  <div class="nav-page nav-page-previous">
      <a  href="/33-anova.html" class="pagination-link" aria-label="One-way ANOVA">
        <i class="bi bi-arrow-left-short"></i> <span class="nav-page-text"><span class='chapter-number'>11</span>¬† <span class='chapter-title'>One-way ANOVA</span></span>
      </a>          
  </div>
  <div class="nav-page nav-page-next">
      <a  href="/35-reg_mult.html" class="pagination-link" aria-label="Multiple regression">
        <span class="nav-page-text"><span class='chapter-number'>13</span>¬† <span class='chapter-title'>Multiple regression</span></span> <i class="bi bi-arrow-right-short"></i>
      </a>
  </div>
</nav>
</div> <!-- /content -->
<footer class="footer">
  <div class="nav-footer">
    <div class="nav-footer-left">
      <div class='footer-contents'><a href="https://biostats-uottawa.github.io/people.html">Julien Martin</a>
</div>  
    </div>   
    <div class="nav-footer-center">
      &nbsp;
    </div>
    <div class="nav-footer-right">
      <div class='footer-contents'>This book was built with <a href="https://quarto.org/">Quarto</a>.
</div>  
    </div>
  </div>
</footer>

</body>

</html>
